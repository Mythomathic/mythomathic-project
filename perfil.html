<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>Perfil - Mythomathic</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="perfil.css">
</head>
<body>
  <header>
    <div class="header-left">
      <a href="map.html" class="btn-link" id="back-to-map">⟵ Tornar al mapa</a>
    </div>

    <h1 id="page-title">El meu perfil</h1>

    <nav class="header-right">
      <ul class="menu">
        <li id="menu-profile"><a href="perfil.html">Perfil</a></li>
        <li id="menu-config"><a href="config.html">Configuració</a></li>
        <li id="menu-about"><a href="sobremi.html">Sobre mi</a></li>
        <li id="menu-contact"><a href="contacte.html">Contacte</a></li>
      </ul>
    </nav>
  </header>

  <div class="profile-container">
    <div id="view-mode">
      <div class="avatar-section">
        <img id="avatar" src="avatars/avatar1.png" alt="Avatar" class="avatar">
      </div>

      <div class="user-info">
        <h2 id="username">Nom d'usuari</h2>
        <p id="email"></p>
      </div>

      <div class="progress-section">
        <p id="level-text"><span id="level-label">Nivell:</span> <span id="level">1</span></p>
        <div class="progress-bar">
          <div class="progress" id="xp-bar"></div>
        </div>
        <p id="xp-text">XP: <span id="xp">0</span> / <span id="xp-max">100</span></p>
        <p id="title-text"><span id="title">Novell de Mythomathic</span></p>
      </div>

      <div class="dimension-section">
        <p id="favorite-dimension-text">Dimensió preferida: Secuentia</p>
      </div>

      <button id="edit-profile">✎ Editar perfil</button>
    </div>

    <button id="logout" class="logout-btn">Tancar sessió</button>

    <div id="edit-mode" style="display:none;">
      <div class="edit-section">
        <label for="edit-username" id="label-edit-username">Nom d'usuari:</label>
        <input type="text" id="edit-username-input">
      </div>

      <div class="edit-section">
        <p id="avatar-text">Escull avatar:</p>
        <div id="avatar-options">
          <!-- Avatar options -->
          <img src="avatar1.png" class="avatar-option">
          <img src="avatar2.png" class="avatar-option">
          <img src="avatar3.png" class="avatar-option">
          <img src="avatar4.png" class="avatar-option">
          <img src="avatar5.png" class="avatar-option">
          <img src="avatar6.png" class="avatar-option">
          <img src="avatar7.png" class="avatar-option">
          <img src="avatar8.png" class="avatar-option">
          <img src="avatar9.png" class="avatar-option">
          <img src="avatar10.png" class="avatar-option">
          <img src="avatar11.png" class="avatar-option">
          <img src="avatar12.png" class="avatar-option">
          <img src="avatar13.png" class="avatar-option">
          <img src="avatar14.png" class="avatar-option">
          <img src="avatar15.png" class="avatar-option">
          <img src="avatar16.png" class="avatar-option">
          <img src="avatar17.png" class="avatar-option">
          <img src="avatar18.png" class="avatar-option">
          <img src="avatar19.png" class="avatar-option">
          <img src="avatar20.png" class="avatar-option">
          <img src="avatar21.png" class="avatar-option">
          <img src="avatar22.png" class="avatar-option">
          <img src="avatar23.png" class="avatar-option">
          <img src="avatar24.png" class="avatar-option">
        </div>
      </div> <br>

      <div class="edit-section">
        <label for="edit-dimension" id="label-edit-dimension">Dimensió preferida:</label>
        <select id="edit-dimension">
          <option value="Secuentia">Secuentia</option>
          <option value="Vectonia">Vectonia</option>
          <option value="Probathénia">Probathénia</option>
          <option value="Realithia">Realithia</option>
          <option value="Ekuatia">Ekuatia</option>
          <option value="Tangentia">Tangentia</option>
          <option value="Complexia">Complexia</option>
          <option value="Functonia">Functonia</option>
          <option value="Derivalia">Derivalia</option>
        </select>
      </div> <br>

      <button id="confirm-edit">✅ Confirmar</button>
      <button id="cancel-edit">❌ Cancel·lar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPVUQZXaSAARwROsDgvlohMvB-esYvMrA",
      authDomain: "mythomathic.firebaseapp.com",
      projectId: "mythomathic",
      storageBucket: "mythomathic.firebasestorage.app",
      messagingSenderId: "396574593247",
      appId: "1:396574593247:web:5b7f02c53de5613eda996a",
      measurementId: "G-P649F73C8E"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Texts per idioma
    const texts = {
      ca: {
        pageTitle: "El meu perfil",
        backToMap: "⟵ Tornar al mapa",
        menu: { profile: "Perfil", config: "Configuració", about: "Sobre mi", contact: "Contacte" },
        level: "Nivell",
        xp: "XP",
        achievements: "Assoliments",
        favoriteDimension: "Dimensió preferida",
        editProfile: "✎ Editar perfil",
        logout: "Tancar sessió",
        editUsername: "Nom d'usuari:",
        avatar: "Escull avatar:",
        confirm: "✅ Confirmar",
        cancel: "❌ Cancel·lar"
      },
      es: {
        pageTitle: "Mi perfil",
        backToMap: "⟵ Volver al mapa",
        menu: { profile: "Perfil", config: "Configuración", about: "Sobre mí", contact: "Contacto" },
        level: "Nivel",
        xp: "XP",
        achievements: "Logros",
        favoriteDimension: "Dimensión favorita",
        editProfile: "✎ Editar perfil",
        logout: "Cerrar sesión",
        editUsername: "Nombre de usuario:",
        avatar: "Elige avatar:",
        confirm: "✅ Confirmar",
        cancel: "❌ Cancelar"
      },
      en: {
        pageTitle: "My profile",
        backToMap: "⟵ Back to map",
        menu: { profile: "Profile", config: "Settings", about: "About me", contact: "Contact" },
        level: "Level",
        xp: "XP",
        achievements: "Achievements",
        favoriteDimension: "Favorite dimension",
        editProfile: "✎ Edit profile",
        logout: "Logout",
        editUsername: "Username:",
        avatar: "Choose avatar:",
        confirm: "✅ Confirm",
        cancel: "❌ Cancel"
      }
    };

    // Titles per nivell i idioma
    const titlesByLang = {
      ca: {
        1: "Custodi del Flux",
        2: "Guardià del Patró",
        3: "Savi d’Ekuatia",
        4: "Somniador de Tangentia",
        5: "Vigilant de Complexia",
        6: "Cercador de Functonia",
        7: "Mestre de Derivalia"
      },
      es: {
        1: "Guardián del Flujo",
        2: "Guardián del Patrón",
        3: "Sabio de Ekuatia",
        4: "Soñador de Tangentia",
        5: "Vigilante de Complexia",
        6: "Buscador de Functonia",
        7: "Maestro de Derivalia"
      },
      en: {
        1: "Flow Keeper",
        2: "Pattern Guardian",
        3: "Ekuatia Sage",
        4: "Tangentia Dreamer",
        5: "Complexia Watcher",
        6: "Functonia Seeker",
        7: "Derivalia Master"
      }
    };

    function getTitle(level, lang) {
      return titlesByLang[lang][level] || `Adventurer Level ${level}`;
    }

    // Elements
    const usernameEl = document.getElementById("username");
    const emailEl = document.getElementById("email");
    const xpEl = document.getElementById("xp");
    const xpMaxEl = document.getElementById("xp-max");
    const xpBar = document.getElementById("xp-bar");
    const levelEl = document.getElementById("level");
    const titleEl = document.getElementById("title");
    const achievementsList = document.getElementById("achievements-list");
    const avatarEl = document.getElementById("avatar");
    const favoriteDimensionText = document.getElementById("favorite-dimension-text");
    const editBtn = document.getElementById("edit-profile");
    const editMode = document.getElementById("edit-mode");
    const viewMode = document.getElementById("view-mode");
    const confirmBtn = document.getElementById("confirm-edit");
    const cancelBtn = document.getElementById("cancel-edit");
    const editUsernameInput = document.getElementById("edit-username-input");
    const editDimension = document.getElementById("edit-dimension");
    const avatarOptions = document.querySelectorAll(".avatar-option");

    const pageTitle = document.getElementById("page-title");
    const backToMap = document.getElementById("back-to-map");
    const labelEditUsername = document.getElementById("label-edit-username");
    const labelEditDimension = document.getElementById("label-edit-dimension");
    const avatarText = document.getElementById("avatar-text");
    const achievementsTitle = document.getElementById("achievements-title");
    const levelLabel = document.getElementById("level-label");

    const menuProfile = document.getElementById("menu-profile");
    const menuConfig = document.getElementById("menu-config");
    const menuAbout = document.getElementById("menu-about");
    const menuContact = document.getElementById("menu-contact");

    let currentUser;
    let selectedAvatar = "avatars/avatar1.png";

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "inici.html"; return; }
      currentUser = user;

      const ref = doc(db, "users", user.uid);
      const snapshot = await getDoc(ref);
      let lang = "ca";

      if (snapshot.exists()) {
        const data = snapshot.data();
        lang = data.language || "ca";

        usernameEl.textContent = data.username || "Usuari sense nom";
        avatarEl.src = data.avatar || "avatars/avatar1.png";
        favoriteDimensionText.textContent = `${texts[lang].favoriteDimension}: ${data.favoriteDimension || "Secuentia"}`;

        const xp = data.xp || 0;
        const level = data.level || 1;
        xpEl.textContent = xp;
        xpMaxEl.textContent = level * 100;
        levelEl.textContent = level;
        xpBar.style.width = `${(xp / (level * 100)) * 100}%`;
        titleEl.textContent = getTitle(level, lang);

        achievementsList.innerHTML = "";
        if (data.achievements) {
          data.achievements.forEach(a => {
            const li = document.createElement("li");
            li.textContent = a;
            achievementsList.appendChild(li);
          });
        }
      } else {
        await setDoc(ref, {
          username: "Nou jugador",
          avatar: "avatars/avatar1.png",
          xp: 0,
          level: 1,
          achievements: [],
          favoriteDimension: "Secuentia",
          language: "ca"
        });
      }

      // Traducció global
      pageTitle.textContent = texts[lang].pageTitle;
      backToMap.textContent = texts[lang].backToMap;
      labelEditUsername.textContent = texts[lang].editUsername;
      labelEditDimension.textContent = texts[lang].favoriteDimension + ":";
      avatarText.textContent = texts[lang].avatar;
      achievementsTitle.textContent = texts[lang].achievements;
      editBtn.textContent = texts[lang].editProfile;
      document.getElementById("logout").textContent = texts[lang].logout;
      confirmBtn.textContent = texts[lang].confirm;
      cancelBtn.textContent = texts[lang].cancel;
      levelLabel.textContent = texts[lang].level + ":";

      // Header
      menuProfile.querySelector("a").textContent = texts[lang].menu.profile;
      menuConfig.querySelector("a").textContent = texts[lang].menu.config;
      menuAbout.querySelector("a").textContent = texts[lang].menu.about;
      menuContact.querySelector("a").textContent = texts[lang].menu.contact;
    });

    editBtn.addEventListener("click", () => {
      viewMode.style.display = "none";
      editMode.style.display = "block";
      editUsernameInput.value = usernameEl.textContent;
      editDimension.value = favoriteDimensionText.textContent.split(": ")[1];
      selectedAvatar = avatarEl.src;
    });

    cancelBtn.addEventListener("click", () => {
      editMode.style.display = "none";
      viewMode.style.display = "block";
    });

    avatarOptions.forEach(img => {
      img.addEventListener("click", () => {
        selectedAvatar = img.src;
        avatarOptions.forEach(i => i.classList.remove("selected"));
        img.classList.add("selected");
      });
    });

    confirmBtn.addEventListener("click", async () => {
      if (currentUser) {
        await updateDoc(doc(db, "users", currentUser.uid), {
          username: editUsernameInput.value,
          avatar: selectedAvatar,
          favoriteDimension: editDimension.value
        });
        usernameEl.textContent = editUsernameInput.value;
        avatarEl.src = selectedAvatar;
        const lang = currentUser.language || "ca";
        favoriteDimensionText.textContent = `${texts[lang].favoriteDimension}: ${editDimension.value}`;
        editMode.style.display = "none";
        viewMode.style.display = "block";
      }
    });

    document.getElementById("logout").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "inici.html";
    });
  </script>
</body>
</html>



