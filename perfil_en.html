<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile - Mythomathic</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="perfil.css">
</head>
<body>
  <header>
    <div class="header-left">
      <a href="map_en.html" class="btn-link">⟵ Back to map</a>
    </div>

    <h1>My Profile</h1>

    <nav class="header-right">
      <ul class="menu">
        <li><a href="perfil_en.html">Profile</a></li>
        <li><a href="config_en.html">Settings</a></li>
        <li><a href="sobremi_en.html">About Me</a></li>
        <li><a href="contacte_en.html">Contact</a></li>
      </ul>
    </nav>
  </header>

  <div class="profile-container">
    <div id="view-mode">
      <div class="avatar-section">
        <img id="avatar" src="avatars/avatar1.png" alt="Avatar" class="avatar">
      </div>

      <div class="user-info">
        <h2 id="username">Username</h2>
        <p id="email"></p>
      </div>

      <div class="progress-section">
        <p>Level: <span id="level">1</span></p>
        <div class="progress-bar">
          <div class="progress" id="xp-bar"></div>
        </div>
        <p>XP: <span id="xp">0</span> / <span id="xp-max">100</span></p>
        <p>Title: <span id="title">Mythomathic Novice</span></p>
      </div>

      <div class="achievements">
        <h3>Achievements</h3>
        <ul id="achievements-list"></ul>
      </div>

      <div class="dimension-section">
        <p id="favorite-dimension-text">Favorite Dimension: Secuentia</p>
      </div>

      <button id="edit-profile">✎ Edit Profile</button>
    </div>

    <button id="logout" class="logout-btn">Log Out</button>

    <!-- Edit mode -->
    <div id="edit-mode" style="display:none;">
      <div class="edit-section">
        <label for="edit-username">Username:</label>
        <input type="text" id="edit-username-input">
      </div>

      <div class="edit-section">
        <p>Select Avatar:</p>
        <div id="avatar-options">
          <img src="avatar1.png" class="avatar-option">
          <img src="avatar2.png" class="avatar-option">
          <img src="avatar3.png" class="avatar-option">
          <img src="avatar4.png" class="avatar-option">
          <img src="avatar5.png" class="avatar-option">
          <img src="avatar6.png" class="avatar-option">
          <img src="avatar7.png" class="avatar-option">
          <img src="avatar8.png" class="avatar-option">
          <img src="avatar9.png" class="avatar-option">
          <img src="avatar10.png" class="avatar-option">
          <img src="avatar11.png" class="avatar-option">
          <img src="avatar12.png" class="avatar-option">
          <img src="avatar13.png" class="avatar-option">
          <img src="avatar14.png" class="avatar-option">
          <img src="avatar15.png" class="avatar-option">
          <img src="avatar16.png" class="avatar-option">
          <img src="avatar17.png" class="avatar-option">
          <img src="avatar18.png" class="avatar-option">
          <img src="avatar19.png" class="avatar-option">
          <img src="avatar20.png" class="avatar-option">
          <img src="avatar21.png" class="avatar-option">
          <img src="avatar22.png" class="avatar-option">
          <img src="avatar23.png" class="avatar-option">
          <img src="avatar24.png" class="avatar-option">
        </div>
      </div> <br>

      <div class="edit-section">
        <label for="edit-dimension">Favorite Dimension:</label>
        <select id="edit-dimension">
          <option value="Secuentia">Secuentia</option>
          <option value="Vectonia">Vectonia</option>
          <option value="Probathénia">Probathénia</option>
          <option value="Realithia">Realithia</option>
          <option value="Ekuatia">Ekuatia</option>
          <option value="Tangentia">Tangentia</option>
          <option value="Complexia">Complexia</option>
          <option value="Functonia">Functonia</option>
          <option value="Derivalia">Derivalia</option>
        </select>
      </div> <br>

      <button id="confirm-edit">✅ Confirm</button>
      <button id="cancel-edit">❌ Cancel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPVUQZXaSAARwROsDgvlohMvB-esYvMrA",
      authDomain: "mythomathic.firebaseapp.com",
      projectId: "mythomathic",
      storageBucket: "mythomathic.firebasestorage.app",
      messagingSenderId: "396574593247",
      appId: "1:396574593247:web:5b7f02c53de5613eda996a",
      measurementId: "G-P649F73C8E"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const usernameEl = document.getElementById("username");
    const emailEl = document.getElementById("email");
    const xpEl = document.getElementById("xp");
    const xpMaxEl = document.getElementById("xp-max");
    const xpBar = document.getElementById("xp-bar");
    const levelEl = document.getElementById("level");
    const titleEl = document.getElementById("title");
    const achievementsList = document.getElementById("achievements-list");
    const avatarEl = document.getElementById("avatar");
    const favoriteDimensionText = document.getElementById("favorite-dimension-text");

    const editBtn = document.getElementById("edit-profile");
    const editMode = document.getElementById("edit-mode");
    const viewMode = document.getElementById("view-mode");
    const confirmBtn = document.getElementById("confirm-edit");
    const cancelBtn = document.getElementById("cancel-edit");
    const editUsernameInput = document.getElementById("edit-username-input");
    const editDimension = document.getElementById("edit-dimension");
    const avatarOptions = document.getElementById("avatar-options");

    let currentUser;
    let selectedAvatar = "avatars/avatar1.png";

    function getTitle(level) {
      const titles = {
        1: "Guardian of the Flow",
        2: "Keeper of the Pattern",
        3: "Sage of Ekuatia",
        4: "Dreamer of Tangentia",
        5: "Watcher of Complexia",
        6: "Seeker of Functonia",
        7: "Master of Derivalia"
      };
      return titles[level] || `Adventurer Level ${level}`;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "inici.html";
      currentUser = user;

      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;

      const data = snap.data();
      usernameEl.textContent = data.username || "Unnamed Player";
      emailEl.textContent = user.email;
      avatarEl.src = data.avatar || "avatars/avatar1.png";
      favoriteDimensionText.textContent = "Favorite Dimension: " + (data.favoriteDimension || "Secuentia");

      const xp = data.xp || 0;
      const level = data.level || 1;
      xpEl.textContent = xp;
      xpMaxEl.textContent = level * 100;
      levelEl.textContent = level;
      xpBar.style.width = `${(xp / (level * 100)) * 100}%`;
      titleEl.textContent = getTitle(level);

      achievementsList.innerHTML = "";
      if (data.achievements) {
        data.achievements.forEach(a => {
          const li = document.createElement("li");
          li.textContent = a;
          achievementsList.appendChild(li);
        });
      }
    });

    editBtn.addEventListener("click", () => {
      viewMode.style.display = "none";
      editMode.style.display = "block";
      editUsernameInput.value = usernameEl.textContent;
    });

    cancelBtn.addEventListener("click", () => {
      editMode.style.display = "none";
      viewMode.style.display = "block";
    });

    avatarOptions.addEventListener("click", (e) => {
      if (e.target.classList.contains("avatar-option")) {
        selectedAvatar = e.target.src;
        document.querySelectorAll(".avatar-option").forEach(i => i.classList.remove("selected"));
        e.target.classList.add("selected");
      }
    });

    confirmBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      await updateDoc(doc(db, "users", currentUser.uid), {
        username: editUsernameInput.value,
        avatar: selectedAvatar,
        favoriteDimension: editDimension.value,
        language: "en"
      });
      location.reload();
    });

    document.getElementById("logout").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "inici.html";
    });
  </script>
</body>
</html>
