<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ekuatia - Mythomathic</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="ekuatia.css">

</head>
<body>
<header>
<button class="back-button" onclick="goTo('map.html')">‚¨Ö Mapa</button>
<div class="title-center">
<img src="E_Title.png" alt="Ekuatia" class="title-img">
</div>
<div class="header-buttons">
<button onclick="openLore()">üìú Lore</button>
<button onclick="toggleMenu()">‚ò∞ Men√∫</button>
</div>
<nav id="menu">
<ul>
<li onclick="goTo('map.html')">Mapa</li>
<li onclick="goTo('perfil.html')">Perfil</li>
<li onclick="goTo('config.html')">Configuraci√≥</li>
<li onclick="goTo('sobremi.html')">Sobre mi</li>
<li onclick="goTo('contacte.html')">Contacte</li>
</ul>
</nav>
</header>

<main class="dimension-container">
<aside class="categories">
<button onclick="showSymbols('equacions')">Equacions</button>
<button onclick="showSymbols('sistemes')">Sistemes</button>
<button onclick="showSymbols('inequacions')">Inequacions</button>
</aside>

<div class="symbols">
<!-- Equacions -->
<img src="icon-eq.png" alt="Equacions" class="symbol" data-cat="equacions"
style="top:180px; left:320px;" onclick="openPopup('Equacions Lineals')">
<img src="icon-eq.png" alt="Equacions" class="symbol" data-cat="equacions"
style="top:300px; left:600px;" onclick="openPopup('Equacions Segon Grau')">
<img src="icon-eq.png" alt="Equacions" class="symbol" data-cat="equacions"
style="top:420px; left:500px;" onclick="openPopup('Equacions Polin√≤miques')">
<img src="icon-eq.png" alt="Equacions" class="symbol" data-cat="equacions"
style="top:540px; left:700px;" onclick="openPopup('Equacions Algebraiques')">
<img src="icon-eq.png" alt="Equacions" class="symbol" data-cat="equacions"
style="top:550px; left:400px;" onclick="openPopup('Equacions Irracionals')">
<img src="icon-eq.png" alt="Equacions" class="symbol" data-cat="equacions"
style="top:600px; left:800px;" onclick="openPopup('Equacions Logaritmiques')">
<img src="icon-eq.png" alt="Equacions" class="symbol" data-cat="equacions"
style="top:720px; left:600px;" onclick="openPopup('Equacions Exponencials')">

<!-- Sistemes -->
<img src="icon-eq.png" alt="Sistemes" class="symbol" data-cat="sistemes"
style="top:220px; left:780px;" onclick="openPopup('Sistemes Lineals')">
<img src="icon-eq.png" alt="Sistemes" class="symbol" data-cat="sistemes"
style="top:420px; left:560px;" onclick="openPopup('Sistemes No Lineals')">
<img src="icon-eq.png" alt="Sistemes" class="symbol" data-cat="sistemes"
style="top:600px; left:960px;" onclick="openPopup('Sistemes 3x3')">

<!-- Inequacions -->
<img src="icon-eq.png" alt="Inequacions" class="symbol" data-cat="inequacions"
style="top:350px; left:940px;" onclick="openPopup('Inequacions Simples')">
<img src="icon-eq.png" alt="Inequacions" class="symbol" data-cat="inequacions"
style="top:510px; left:260px;" onclick="openPopup('Inequacions Quadratiques')">
<img src="icon-eq.png" alt="Inequacions" class="symbol" data-cat="inequacions"
style="top:630px; left:760px;" onclick="openPopup('Sistemes d‚ÄôInequacions')">
</div>
</main>

<div id="lorePopup" class="popup">
<div class="popup-content lore-content">
<span class="close" onclick="closeLore()">&times;</span>
<img src="pergami.png" alt="Pergam√≠" class="scroll-img">
</div>
</div>

<div id="exercisePopup" class="popup">
<div class="popup-content">
<span class="close" onclick="closePopup()">&times;</span>
<h2 id="exerciseTitle"></h2>
<div id="exerciseContent"></div>
<p id="feedback"></p>
</div>
</div>

<!-- CHATBOT -->
<div id="capy-toggle">
  <img src="capy2.png" alt="Capy">
</div>

<div id="capy-chat" class="hidden">
  <div class="capy-header">
    <img src="capy2.png" alt="Capy">
    <span>Capy - Guia</span>
  </div>
  <div id="capy-messages"></div>
  <input id="capy-input" placeholder="Pregunta a Capy...">
  <div id="capy-thinking" class="hidden">
  <span class="dot"></span>
  <span class="dot"></span>
  <span class="dot"></span>
</div>
</div>

<script>
function toggleMenu(){document.getElementById('menu').classList.toggle('active');}
function goTo(page){window.location.href=page;}
function openLore(){document.getElementById("lorePopup").style.display="flex";}
function closeLore(){document.getElementById("lorePopup").style.display="none";}
function showSymbols(type){
document.querySelectorAll(".symbol").forEach(el=>el.style.display="none");
document.querySelectorAll(".symbol[data-cat='"+type+"']").forEach(el=>el.style.display="block");
}
document.addEventListener("DOMContentLoaded",()=>{showSymbols("equacions");});
function closePopup(){document.getElementById("exercisePopup").style.display="none";}

// ===== Funcions auxiliars =====
function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

/* ---------- CHATBOT ---------- */
const capyToggle = document.getElementById("capy-toggle");
const capyChat = document.getElementById("capy-chat");
const capyInput = document.getElementById("capy-input");
const capyMessages = document.getElementById("capy-messages");

capyToggle.onclick = () => capyChat.classList.toggle("hidden");

capyInput.addEventListener("keypress", async (e) => {
  if (e.key === "Enter" && capyInput.value.trim()) {
    const msg = capyInput.value.trim();
    capyMessages.innerHTML += `<p><b>Tu:</b> ${msg}</p>`;
    capyInput.value = "";

    // MOSTREM punts de pensament
    const thinking = document.getElementById("capy-thinking");
    thinking.classList.remove("hidden");

    // Enviem el missatge al servidor
    try {
      const res = await fetch('https://mythomathic-server.onrender.com/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg }),
      });

      const data = await res.json();

      // OCULTEM punts quan arriba la resposta
      thinking.classList.add("hidden");

      // Afegim missatge de Capy amb s√≠mbols matem√†tics
      capyMessages.innerHTML += `<p><b>Capy:</b> ${data.reply}</p>`;
      MathJax.typesetPromise();
      capyMessages.scrollTop = capyMessages.scrollHeight;

    } catch (err) {
      thinking.classList.add("hidden"); // assegurem amagar punts si hi ha error
      capyMessages.innerHTML += `<p><b>Capy:</b> Ups! Hi ha hagut un error al enviar el missatge.</p>`;
      capyMessages.scrollTop = capyMessages.scrollHeight;
    }
  }
});

// ===== POPUP Exercicis =====
const exercises = {
"Equacions Lineals": () => {
    const a = randomInt(1,5);
    const b = randomInt(-5,5);
    const c = randomInt(1,10);
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol l'equaci√≥: ${a}¬∑x + ${b} = ${c}</p>
    <input type="text" id="answer">
    <button onclick="checkLinear(${a},${b},${c})">Comprovar</button>
    <button onclick="exercises['Equacions Lineals']()">Nova activitat</button>`;
},

"Equacions Segon Grau": () => {
    const x1 = randomInt(1,5);
    const x2 = randomInt(6,10);
    const a = 1;
    const b = - (x1 + x2);
    const c = x1 * x2;
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol l'equaci√≥: x¬≤ + (${b})¬∑x + (${c}) = 0</p>
    <input type="text" id="answer" placeholder="Respon amb x1,x2">
    <button onclick="checkQuadratic(${x1},${x2})">Comprovar</button>
    <button onclick="exercises['Equacions Segon Grau']()">Nova activitat</button>`;
},

"Equacions Polin√≤miques": () => {
    const a = randomInt(1,3);
    const b = randomInt(1,5);
    const c = randomInt(1,5);
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol l'equaci√≥ polin√≤mica: ${a}x¬≥ + ${b}x¬≤ - ${c} = 0</p>
    <input type="text" id="answer">
    <button onclick="checkPolynomial(${a},${b},${c})">Comprovar</button>
    <button onclick="exercises['Equacions Polin√≤miques']()">Nova activitat</button>`;
},

"Equacions Algebraiques": () => {
    const a = randomInt(2,5);
    const b = randomInt(1,5);
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol l'equaci√≥: x¬≤ - ${a}/x = ${b}</p>
    <input type="text" id="answer">
    <button onclick="checkAlgebraic(${a},${b})">Comprovar</button>
    <button onclick="exercises['Equacions Algebraiques']()">Nova activitat</button>`;
},

"Equacions Irracionals": () => {
    const r = randomInt(3,10);
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol l'equaci√≥: ‚àöx = ${r}</p>
    <input type="text" id="answer">
    <button onclick="checkIrrational(${r})">Comprovar</button>
    <button onclick="exercises['Equacions Irracionals']()">Nova activitat</button>`;
},

"Equacions Logaritmiques": () => {
    const b = 2;
    const r = randomInt(1,10);
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol l'equaci√≥ logar√≠tmica: log${b}(x) = ${r}</p>
    <input type="text" id="answer">
    <button onclick="checkLogarithm(${b},${r})">Comprovar</button>
    <button onclick="exercises['Equacions Logaritmiques']()">Nova activitat</button>`;
},

"Equacions Exponencials": () => {
    const b = randomInt(2,5);
    const r = randomInt(2,20);
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol l'equaci√≥ exponencial: ${b}<sup>x</sup> = ${r}</p>
    <input type="text" id="answer">
    <button onclick="checkExponential(${b},${r})">Comprovar</button>
    <button onclick="exercises['Equacions Exponencials']()">Nova activitat</button>`;
},

"Sistemes Lineals": () => {
    const x1 = randomInt(1,5);
    const y1 = randomInt(1,5);
    const c1 = x1 + y1;
    const x2 = randomInt(1,5);
    const y2 = randomInt(1,5);
    const c2 = x2 + y2;
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol el sistema:</p>
    <p>x + y = ${c1}</p>
    <p>${x2}x + ${y2}y = ${c2}</p>
    <input type="text" id="answer" placeholder="x,y">
    <button onclick="checkSystemLinear(${c1},${x2},${y2},${c2})">Comprovar</button>
    <button onclick="exercises['Sistemes Lineals']()">Nova activitat</button>`;
},

"Sistemes No Lineals": () => {
    const x = randomInt(1,5);
    const y = randomInt(1,5);
    const sum = x + y;
    const prod = x * y;
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol el sistema:</p>
    <p>x + y = ${sum}</p>
    <p>xy = ${prod}</p>
    <input type="text" id="answer" placeholder="x,y">
    <button onclick="checkSystemNonLinear(${x},${y})">Comprovar</button>
    <button onclick="exercises['Sistemes No Lineals']()">Nova activitat</button>`;
},

"Sistemes 3x3": () => {
    const x = randomInt(1,3);
  const y = randomInt(1,3);
  const z = randomInt(1,3);
  const a1 = randomInt(1,4), b1 = randomInt(1,4), c1c = randomInt(1,4);
  const a2 = randomInt(1,4), b2 = randomInt(1,4), c2c = randomInt(1,4);
  const a3 = randomInt(1,4), b3 = randomInt(1,4), c3c = randomInt(1,4);
  const d1 = a1*x + b1*y + c1c*z;
  const d2 = a2*x + b2*y + c2c*z;
  const d3 = a3*x + b3*y + c3c*z;
  const container = document.getElementById("exerciseContent");
  container.innerHTML = `
  <p>Resol el sistema 3x3:</p>
  <p>${a1}x + ${b1}y + ${c1c}z = ${d1}</p>
  <p>${a2}x + ${b2}y + ${c2c}z = ${d2}</p>
  <p>${a3}x + ${b3}y + ${c3c}z = ${d3}</p>
  <input type="text" id="answer" placeholder="x,y,z">
  <button onclick="checkSystem3x3(${x},${y},${z})">Comprovar</button>
  <button onclick="exercises['Sistemes 3x3']()">Nova activitat</button>`;
},

"Inequacions Simples": () => {
    const a = randomInt(1,5);
    const b = randomInt(1,5);
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol la inequaci√≥: ${a}x - ${b} &ge; 0</p>
    <input type="text" id="answer">
    <button onclick="checkInequationSimple(${a},${b})">Comprovar</button>
    <button onclick="exercises['Inequacions Simples']()">Nova activitat</button>`;
},

"Inequacions Quadratiques": () => {
    const x1 = randomInt(1,5);
    const x2 = randomInt(6,10);
    const a = 1;
    const b = - (x1 + x2);
    const c = x1 * x2;
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol la inequaci√≥: x¬≤ + (${b})x + (${c}) &le; 0</p>
    <input type="text" id="answer" placeholder="x ‚àà [...]">
    <button onclick="checkInequationQuadratic(${x1},${x2})">Comprovar</button>
    <button onclick="exercises['Inequacions Quadratiques']()">Nova activitat</button>`;
},

"Sistemes d‚ÄôInequacions": () => {
    const a1 = randomInt(1,5);
    const b1 = randomInt(1,5);
    const a2 = randomInt(1,5);
    const b2 = randomInt(1,5);
    const container = document.getElementById("exerciseContent");
    container.innerHTML = `
    <p>Resol el sistema d'inequacions:</p>
    <p>${a1}x + ${b1}y &ge; 0</p>
    <p>${a2}x - ${b2}y &lt; 5</p>
    <input type="text" id="answer" placeholder="x,y">
    <button onclick="checkSystemIneq(${a1},${b1},${a2},${b2})">Comprovar</button>
    <button onclick="exercises['Sistemes d‚ÄôInequacions']()">Nova activitat</button>`;
}
}

<!-- ===== FUNCIONS DE COMPROVACI√ì ===== -->

function checkLinear(a,b,c){
    const user = Number(document.getElementById("answer").value.trim());
    const correct = (c-b)/a;
    const fb = document.getElementById("feedback");
    if(user===correct){fb.textContent="Correcte! ‚úîÔ∏è"; fb.style.color="green"; onExerciseCorrect();}
    else{fb.textContent=`Incorrecte ‚ùå (resposta: ${correct})`; fb.style.color="red";}
}

function checkQuadratic(x1,x2){
    const user = document.getElementById("answer").value.trim().split(",").map(Number).sort((a,b)=>a-b);
    const correct = [x1,x2].sort((a,b)=>a-b);
    const fb = document.getElementById("feedback");
    if(user[0]===correct[0] && user[1]===correct[1]){fb.textContent="Correcte! ‚úîÔ∏è"; fb.style.color="green"; onExerciseCorrect();}
    else{fb.textContent=`Incorrecte ‚ùå (resposta: ${correct.join(",")})`; fb.style.color="red";}
}


function checkPolynomial(a,b,c){
    const correct = Math.cbrt(c/a * -1) || 0; 
    const user = Number(document.getElementById("answer").value.trim());
    const fb = document.getElementById("feedback");
    if(Math.abs(user - correct) < 0.01){ 
        fb.textContent="Correcte! ‚úîÔ∏è"; fb.style.color="green"; onExerciseCorrect();
    } else {
        fb.textContent=`Incorrecte ‚ùå (resposta aprox.: ${correct.toFixed(2)})`;
        fb.style.color="red";
    }
}


function checkAlgebraic(a,b){
    // Equaci√≥: x¬≤ - a/x = b  ‚Üí  x¬≥ - b¬∑x - a = 0
    const correct = Math.cbrt(a); // arrel aproximada positiva
    const user = Number(document.getElementById("answer").value.trim());
    const fb = document.getElementById("feedback");
    if(Math.abs(user - correct) < 0.01){
        fb.textContent="Correcte! ‚úîÔ∏è"; fb.style.color="green"; onExerciseCorrect();
    } else {
        fb.textContent=`Incorrecte ‚ùå (resposta aprox.: ${correct.toFixed(2)})`;
        fb.style.color="red";
    }
}

function checkIrrational(r){
    const user = Number(document.getElementById("answer").value.trim());
    const correct = r**2;
    const fb = document.getElementById("feedback");
    if(user===correct){fb.textContent="Correcte! ‚úîÔ∏è"; fb.style.color="green"; onExerciseCorrect();}
    else{fb.textContent=`Incorrecte ‚ùå (resposta: ${correct})`; fb.style.color="red";}
}

function checkLogarithm(b,r){
    const user = Number(document.getElementById("answer").value.trim());
    const correct = Math.pow(b,r);
    const fb = document.getElementById("feedback");
    if(user===correct){fb.textContent="Correcte! ‚úîÔ∏è"; fb.style.color="green"; onExerciseCorrect();}
    else{fb.textContent=`Incorrecte ‚ùå (resposta: ${correct})`; fb.style.color="red";}
}

function checkExponential(b,r){
    const user = Number(document.getElementById("answer").value.trim());
    const correct = Math.log(r)/Math.log(b);
    const fb = document.getElementById("feedback");
    if(Math.abs(user-correct)<0.001){fb.textContent="Correcte! ‚úîÔ∏è"; fb.style.color="green"; onExerciseCorrect();}
    else{fb.textContent=`Incorrecte ‚ùå (resposta: ${correct.toFixed(3)})`; fb.style.color="red";}
}

function checkSystemLinear(c1,x2,y2,c2){
  const fb = document.getElementById("feedback");
  const det = (1 * y2) - (x2 * 1);
  if (det === 0) {
    fb.textContent = "El sistema no t√© soluci√≥ √∫nica (infinites o cap). ‚ö†Ô∏è";
    fb.style.color = "orange";
    return;
  }
  const x = (c1 * y2 - c2 * 1) / det;
  const y = (1 * c2 - x2 * c1) / det;
  const user = document.getElementById("answer").value.trim().split(",").map(Number);
  if (Math.abs(user[0] - x) < 0.01 && Math.abs(user[1] - y) < 0.01) {
    fb.textContent = "Correcte! ‚úîÔ∏è";
    fb.style.color = "green";
    onExerciseCorrect();
  } else {
    fb.textContent = `Incorrecte ‚ùå (resposta: x=${x.toFixed(2)}, y=${y.toFixed(2)})`;
    fb.style.color = "red";
  }
}

function checkSystemNonLinear(x,y){
    const user = document.getElementById("answer").value.trim().split(",").map(Number);
    const fb = document.getElementById("feedback");
    if(user[0]===x && user[1]===y){fb.textContent="Correcte! ‚úîÔ∏è"; fb.style.color="green"; onExerciseCorrect();}
    else{fb.textContent=`Incorrecte ‚ùå (resposta: ${x},${y})`; fb.style.color="red";}
}

function checkSystem3x3(x,y,z){
    const user = document.getElementById("answer").value.trim().split(",").map(Number);
    const fb = document.getElementById("feedback");
    if(user[0]===x && user[1]===y && user[2]===z){fb.textContent="Correcte! ‚úîÔ∏è"; fb.style.color="green"; onExerciseCorrect();}
    else{fb.textContent=`Incorrecte ‚ùå (resposta: ${x},${y},${z})`; fb.style.color="red";}
}

function checkInequationSimple(a,b){
  const correctValue = (b / a).toFixed(2);
  const correct = `x >= ${correctValue}`;
  const user = document.getElementById("answer").value.trim();
  const fb = document.getElementById("feedback");
  if (user === correct) {
    fb.textContent = "Correcte! ‚úîÔ∏è";
    fb.style.color = "green";
    onExerciseCorrect();
  } else {
    fb.textContent = `Incorrecte ‚ùå (resposta: ${correct})`;
    fb.style.color = "red";
  }
}

function checkInequationQuadratic(x1,x2){
    const correct = `[${x1}, ${x2}]`;
    const user = document.getElementById("answer").value.trim();
    const fb = document.getElementById("feedback");
    if(user===correct){fb.textContent="Correcte! ‚úîÔ∏è"; fb.style.color="green"; onExerciseCorrect();}
    else{fb.textContent=`Incorrecte ‚ùå (resposta: ${correct})`; fb.style.color="red";}
}


function checkSystemIneq(a1,b1,a2,b2){
  const fb = document.getElementById("feedback");
  // Calcul senzill: igualtat dels dos per trobar el punt d‚Äôintersecci√≥
  const y1 = x => -(a1/b1)*x;
  const y2 = x => ((5 - a2*x)/(-b2));
  const interX = (5*b1) / (a2*b1 - a1*b2);
  const interY = y1(interX);
  const correct = `Intersecci√≥ aprox.: (x=${interX.toFixed(2)}, y=${interY.toFixed(2)})`;
  const user = document.getElementById("answer").value.trim();
  if (user.includes(interX.toFixed(2)) && user.includes(interY.toFixed(2))) {
    fb.textContent = "Correcte! ‚úîÔ∏è";
    fb.style.color = "green";
    onExerciseCorrect();
  } else {
    fb.textContent = `Incorrecte ‚ùå (${correct})`;
    fb.style.color = "red";
  }
}


function openPopup(title){
    document.getElementById("exerciseTitle").textContent=title;
    document.getElementById("exercisePopup").style.display="flex";
    document.getElementById("exerciseContent").innerHTML="";
    document.getElementById("feedback").textContent="";
    if(exercises[title]) exercises[title]();
    else document.getElementById("exerciseContent").innerHTML="<p>Encara no hi ha exercicis disponibles.</p>";
}


let correctExercises=0;
let xp=parseInt(localStorage.getItem("xp"))||0;
let level=parseInt(localStorage.getItem("level"))||1;
let xpGainBase=50;

function addXP(amount){
  xp+=amount;
  const xpMax=level*100;
  if(xp>=xpMax){ xp-=xpMax; level++; gainTitle(level); }
  localStorage.setItem("xp",xp);
  localStorage.setItem("level",level);
  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);
}
function gainTitle(level){
  const titles={
    1:"Custodi del Flux",2:"Guardi√† del Patr√≥",3:"Savi d‚ÄôEkuatia",
    4:"Somniador de Tangentia",5:"Vigilant de Complexia",
    6:"Cercador de Functonia",7:"Mestre de Derivalia"
  };
  const newTitle=titles[level]||`Aventurer Nivell ${level}`;
  alert(`‚ú® Has pujat de nivell! Nou t√≠tol: ${newTitle}`);
  localStorage.setItem("title",newTitle);
}
function onExerciseCorrect(){
  correctExercises++;
  if(correctExercises%5===0){
    const earnedXP=Math.max(10,xpGainBase-(level-1)*5);
    addXP(earnedXP);
  }
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// üîπ Configuraci√≥ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDPVUQZXaSAARwROsDgvlohMvB-esYvMrA",
  authDomain: "mythomathic.firebaseapp.com",
  projectId: "mythomathic",
  storageBucket: "mythomathic.firebasestorage.app",
  messagingSenderId: "396574593247",
  appId: "1:396574593247:web:5b7f02c53de5613eda996a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

// üîπ Quan l‚Äôusuari est√† autenticat, recuperem el seu XP actual
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    const ref = doc(db, "users", user.uid);
    const snapshot = await getDoc(ref);
    if (snapshot.exists()) {
      const data = snapshot.data();
      xp = data.xp || 0;
      level = data.level || 1;
      localStorage.setItem("xp", xp);
      localStorage.setItem("level", level);
    }
  } else {
    console.warn("Usuari no autenticat ‚Äî XP nom√©s local.");
  }
});

// üîπ Funci√≥ per sincronitzar XP amb la base de dades
async function updateXPInDB(newXP, newLevel) {
  if (!currentUser) return;
  try {
    await updateDoc(doc(db, "users", currentUser.uid), {
      xp: newXP,
      level: newLevel
    });
    console.log("‚úÖ XP actualitzat al n√∫vol:", newXP, "nivell:", newLevel);
  } catch (err) {
    console.error("‚ùå Error actualitzant XP a Firestore:", err);
  }
}

// ‚ú® Modifica la funci√≥ addXP perqu√® actualitzi Firebase tamb√©
window.addXP = async function(amount) {
  xp += amount;
  const xpMax = level * 100;
  if (xp >= xpMax) {
    xp -= xpMax;
    level++;
    gainTitle(level);
  }

  localStorage.setItem("xp", xp);
  localStorage.setItem("level", level);

  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);

  await updateXPInDB(xp, level);
};

</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
 src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

</body>
</html>


