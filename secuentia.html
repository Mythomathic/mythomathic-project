<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secuentia - Mythomathic</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="secuentia.css">
</head>

<body>
<header>
  <button class="back-button" onclick="goTo('map.html')">‚¨Ö Mapa</button>
  <div class="title-center">
    <img src="S_Title.png" alt="Secuentia" class="title-img">
  </div>
  <div class="header-buttons">
    <button onclick="openLore()">üìú Lore</button>
    <button onclick="toggleMenu()">‚ò∞ Men√∫</button>
  </div>
  <nav id="menu">
    <ul>
      <li onclick="goTo('map.html')">Mapa</li>
      <li onclick="goTo('perfil.html')">Perfil</li>
      <li onclick="goTo('config.html')">Configuraci√≥</li>
      <li onclick="goTo('sobremi.html')">Sobre mi</li>
      <li onclick="goTo('contacte.html')">Contacte</li>
    </ul>
  </nav>
</header>

<main class="dimension-container">
  <aside class="categories">
    <button onclick="showSymbols('aritmetiques')">P. Aritm√®tiques</button>
    <button onclick="showSymbols('geometriques')">P. Geom√®triques</button>
    <button onclick="showSymbols('generals')">Termes Generals</button>
  </aside>

  <div class="symbols">
    <!-- PA -->
    <img src="icon-sec.png" class="symbol" data-cat="aritmetiques" style="top:180px;left:320px;" onclick="openPopup('Suma i termes de PA')">
    <img src="icon-sec.png" class="symbol" data-cat="aritmetiques" style="top:430px;left:980px;" onclick="openPopup('Troba el terme general PA')">

    <!-- PG -->
    <img src="icon-sec.png" class="symbol" data-cat="geometriques" style="top:220px;left:780px;" onclick="openPopup('Suma i termes de PG')">
    <img src="icon-sec.png" class="symbol" data-cat="geometriques" style="top:420px;left:560px;" onclick="openPopup('Troba el terme general PG')">

    <!-- Generals -->
    <img src="icon-sec.png" class="symbol" data-cat="generals" style="top:350px;left:940px;" onclick="openPopup('Calcula termes de la successi√≥')">
    <img src="icon-sec.png" class="symbol" data-cat="generals" style="top:510px;left:260px;" onclick="openPopup('Troba el terme indicat')">
  </div>
</main>

<!-- LORE -->
<div id="lorePopup" class="popup">
  <div class="popup-content lore-content">
    <span class="close" onclick="closeLore()">&times;</span>
    <img src="lore_S.png" alt="Pergam√≠" class="scroll-img">
  </div>
</div>

<!-- EXERCICIS -->
<div id="exercisePopup" class="popup">
  <div class="popup-content">
    <span class="close" onclick="closePopup()">&times;</span>
    <h2 id="exerciseTitle"></h2>
    <div id="exerciseContent"></div>
  </div>
</div>

<script>
function toggleMenu(){ document.getElementById('menu').classList.toggle('active'); }
function goTo(page){ window.location.href = page; }
function openLore(){ document.getElementById("lorePopup").style.display = "flex"; }
function closeLore(){ document.getElementById("lorePopup").style.display = "none"; }

document.addEventListener("DOMContentLoaded",()=>{
  const lorePopup=document.getElementById("lorePopup");
  if(lorePopup){
    lorePopup.addEventListener("click",(e)=>{ if(e.target===lorePopup) closeLore(); });
  }
  showSymbols("aritmetiques");
});

function showSymbols(type){
  document.querySelectorAll(".symbol").forEach(el=>el.style.display="none");
  document.querySelectorAll(`.symbol[data-cat='${type}']`).forEach(el=>el.style.display="block");
}
function closePopup(){ document.getElementById("exercisePopup").style.display="none"; }
function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

// ==================== EXERCICIS ======================
const exercises = {
  // --- Successions generals ---
  "Calcula termes de la successi√≥": ()=>{
    const n=randomInt(3,7), a=randomInt(1,5), b=randomInt(1,5);
    const expr=`a‚Çô = ${a}¬∑n¬≤ + ${b}¬∑n`;
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`<p>Troba els ${n} primers termes de la successi√≥:</p>
    <p><b>${expr}</b></p>
    <input id="answer" placeholder="Ex: 2, 6, 12..." />
    <button onclick="generateTermsExercise(${a},${b},${n})">Comprovar</button>
    <button onclick="exercises['Calcula termes de la successi√≥']()">Nova activitat</button>
    <p id="feedback"></p>`;
  },

  "Troba el terme indicat": ()=>{
    const n=randomInt(5,15), a=randomInt(1,5), b=randomInt(-5,5);
    const expr=`a‚Çô = ${a}¬∑n + ${b}`;
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`<p>Troba el terme a<sub>${n}</sub> de la successi√≥:</p>
    <p><b>${expr}</b></p>
    <input id="answer" placeholder="Ex: 12" />
    <button onclick="checkTerm(${a},${b},${n})">Comprovar</button>
    <button onclick="exercises['Troba el terme indicat']()">Nova activitat</button>
    <p id="feedback"></p>`;
  },

  // --- Progressions aritm√®tiques ---
 "Suma i termes de PA": ()=>{
    const a2=randomInt(1,10), a7=randomInt(20,50);
    const d=(a7-a2)/5, a1=a2-d;
    const terms=Array.from({length:5},(_,i)=>+(a1+i*d).toFixed(2)); // <-- arrodonim a 2 decimals
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`<p>En una progressi√≥ aritm√®tica, a‚ÇÇ = ${a2} i a‚Çá = ${a7}. Escriu els 5 primers termes.</p>
    <input id="answer" placeholder="Ex: 2.2, 6, 9.8, ..." />
    <button onclick="checkPA1(${a1},${d},'${terms.join(', ')}')">Comprovar</button>
    <button onclick="exercises['Suma i termes de PA']()">Nova activitat</button>
    <p id="feedback"></p>`;
},

  "Troba el terme general PA": ()=>{
    const a=randomInt(1,10), d=randomInt(2,6), n=randomInt(4,10);
    const a_n=a+d*(n-1);
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`<p>En una progressi√≥ aritm√®tica amb a‚ÇÅ = ${a} i d = ${d}, troba el terme a<sub>${n}</sub>.</p>
    <input id="answer" placeholder="Ex: 34" />
    <button onclick="checkPATerm(${a},${d},${n})">Comprovar</button>
    <button onclick="exercises['Troba el terme general PA']()">Nova activitat</button>
    <p id="feedback"></p>`;
  },

  // --- Progressions geom√®triques ---
  "Suma i termes de PG": ()=>{
    const a1=randomInt(2,6), r=(Math.random()<0.5)?0.5:0.25;
    const sInf=a1/(1-r);
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`<p>Calcula la suma infinita de la successi√≥: ${a1}, ${a1*r}, ${a1*r**2}, ${a1*r**3}, ...</p>
    <input id="answer" placeholder="Ex: 12" />
    <button onclick="checkPGSum(${a1},${r},${sInf})">Comprovar</button>
    <button onclick="exercises['Suma i termes de PG']()">Nova activitat</button>
    <p id="feedback"></p>`;
  },

  "Troba el terme general PG": ()=>{
    const a1=randomInt(2,6), r=randomInt(2,4);
    const c5=a1*r**4;
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`<p>El cinqu√® terme d'una PG √©s ${c5} i el primer √©s ${a1}. Troba els 5 primers termes.</p>
    <input id="answer" placeholder="Ex: 3, 6, 12, 24, 48" />
    <button onclick="checkPGTerms(${a1},${r})">Comprovar</button>
    <button onclick="exercises['Troba el terme general PG']()">Nova activitat</button>
    <p id="feedback"></p>`;
  }
};

function openPopup(title){
  document.getElementById("exerciseTitle").textContent=title;
  document.getElementById("exercisePopup").style.display="flex";
  document.getElementById("exerciseContent").innerHTML="";
  exercises[title] ? exercises[title]() :
  document.getElementById("exerciseContent").innerHTML="<p>No hi ha exercicis disponibles.</p>";
}

// ================== COMPROVACIONS ====================
function generateTermsExercise(a,b,n){
  const correct=Array.from({length:n},(_,i)=>a*(i+1)**2+b*(i+1)).join(", ");
  const user=document.getElementById("answer").value.trim();
  const fb=document.getElementById("feedback");
  if(user===correct){ fb.textContent="Correcte! ‚úîÔ∏è"; onExerciseCorrect(); }
  else fb.textContent=`Incorrecte ‚ùå (resposta esperada: ${correct})`;
}
function checkTerm(a,b,n){
  const correct=a*n+b;
  const user=Number(document.getElementById("answer").value.trim());
  const fb=document.getElementById("feedback");
  if(user===correct){ fb.textContent="Correcte! ‚úîÔ∏è"; onExerciseCorrect(); }
  else fb.textContent=`Incorrecte ‚ùå (resposta esperada: ${correct})`;
}
function checkPA1(a1,d,terms){
    // Generem els termes arrodonits a 2 decimals
    const correctTerms = Array.from({length:5},(_,i)=>+(a1+i*d).toFixed(2)).join(", ");
    const user=document.getElementById("answer").value.trim();
    const fb=document.getElementById("feedback");
    if(user===correctTerms){ fb.textContent="Correcte! ‚úîÔ∏è"; onExerciseCorrect(); }
    else fb.textContent=`Incorrecte ‚ùå (resposta esperada: ${correctTerms})`;
}
function checkPATerm(a,d,n){
  const correct=a+d*(n-1);
  const user=Number(document.getElementById("answer").value.trim());
  const fb=document.getElementById("feedback");
  if(user===correct){ fb.textContent="Correcte! ‚úîÔ∏è"; onExerciseCorrect(); }
  else fb.textContent=`Incorrecte ‚ùå (resposta esperada: ${correct})`;
}
function checkPGSum(a1,r,sInf){
  const correct=+(a1/(1-r)).toFixed(2);
  const user=parseFloat(document.getElementById("answer").value.trim());
  const fb=document.getElementById("feedback");
  if(Math.abs(user-correct)<0.01){ fb.textContent="Correcte! ‚úîÔ∏è"; onExerciseCorrect(); }
  else fb.textContent=`Incorrecte ‚ùå (resposta esperada: ${correct})`;
}
function checkPGTerms(a1,r){
  const correct=Array.from({length:5},(_,i)=>a1*Math.pow(r,i)).join(", ");
  const user=document.getElementById("answer").value.trim();
  const fb=document.getElementById("feedback");
  if(user===correct){ fb.textContent="Correcte! ‚úîÔ∏è"; onExerciseCorrect(); }
  else fb.textContent=`Incorrecte ‚ùå (resposta esperada: ${correct})`;
}

// ================== EXPERI√àNCIA =====================
let correctExercises=0;
let xp=parseInt(localStorage.getItem("xp"))||0;
let level=parseInt(localStorage.getItem("level"))||1;
let xpGainBase=50;

function addXP(amount){
  xp+=amount;
  const xpMax=level*100;
  if(xp>=xpMax){ xp-=xpMax; level++; gainTitle(level); }
  localStorage.setItem("xp",xp);
  localStorage.setItem("level",level);
  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);
}
function gainTitle(level){
  const titles={
    1:"Custodi del Flux",2:"Guardi√† del Patr√≥",3:"Savi d‚ÄôEkuatia",
    4:"Somniador de Tangentia",5:"Vigilant de Complexia",
    6:"Cercador de Functonia",7:"Mestre de Derivalia"
  };
  const newTitle=titles[level]||`Aventurer Nivell ${level}`;
  alert(`‚ú® Has pujat de nivell! Nou t√≠tol: ${newTitle}`);
  localStorage.setItem("title",newTitle);
}
function onExerciseCorrect(){
  correctExercises++;
  if(correctExercises%5===0){
    const earnedXP=Math.max(10,xpGainBase-(level-1)*5);
    addXP(earnedXP);
  }
}
</script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// üîπ Configuraci√≥ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDPVUQZXaSAARwROsDgvlohMvB-esYvMrA",
  authDomain: "mythomathic.firebaseapp.com",
  projectId: "mythomathic",
  storageBucket: "mythomathic.firebasestorage.app",
  messagingSenderId: "396574593247",
  appId: "1:396574593247:web:5b7f02c53de5613eda996a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

// üîπ Quan l‚Äôusuari est√† autenticat, recuperem el seu XP actual
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    const ref = doc(db, "users", user.uid);
    const snapshot = await getDoc(ref);
    if (snapshot.exists()) {
      const data = snapshot.data();
      xp = data.xp || 0;
      level = data.level || 1;
      localStorage.setItem("xp", xp);
      localStorage.setItem("level", level);
    }
  } else {
    console.warn("Usuari no autenticat ‚Äî XP nom√©s local.");
  }
});

// üîπ Funci√≥ per sincronitzar XP amb la base de dades
async function updateXPInDB(newXP, newLevel) {
  if (!currentUser) return;
  try {
    await updateDoc(doc(db, "users", currentUser.uid), {
      xp: newXP,
      level: newLevel
    });
    console.log("‚úÖ XP actualitzat al n√∫vol:", newXP, "nivell:", newLevel);
  } catch (err) {
    console.error("‚ùå Error actualitzant XP a Firestore:", err);
  }
}

// ‚ú® Modifica la funci√≥ addXP perqu√® actualitzi Firebase tamb√©
window.addXP = async function(amount) {
  xp += amount;
  const xpMax = level * 100;
  if (xp >= xpMax) {
    xp -= xpMax;
    level++;
    gainTitle(level);
  }

  localStorage.setItem("xp", xp);
  localStorage.setItem("level", level);

  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);

  await updateXPInDB(xp, level);
};




</script>
</body>
</html>

