<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Functonia - Mythomathic</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="functonia.css">
</head>
<body>

<header>
  <button class="back-button" onclick="goTo('map.html')">‚¨Ö Mapa</button>
  <div class="title-center">
    <img src="F_Title.png" alt="Functonia" class="title-img">
  </div>
  <div class="header-buttons">
    <button onclick="openLore()">üìú Lore</button>
    <button onclick="toggleMenu()">‚ò∞ Men√∫</button>
  </div>
  <nav id="menu">
    <ul>
      <li onclick="goTo('map.html')">Mapa</li>
      <li onclick="goTo('perfil.html')">Perfil</li>
      <li onclick="goTo('config.html')">Configuraci√≥</li>
      <li onclick="goTo('sobremi.html')">Sobre mi</li>
      <li onclick="goTo('contacte.html')">Contacte</li>
    </ul>
  </nav>
</header>

<main class="dimension-container">
  <aside class="categories">
    <button onclick="showSymbols('domini')">Domini</button>
    <button onclick="showSymbols('paraboles')">Par√†boles</button>
    <button onclick="showSymbols('altres')">Altres funcions</button>
    <button onclick="showSymbols('limits')">L√≠mits & Continu√Øtat</button>
  </aside>

  <div class="symbols">
    <!-- Domini -->
    <img src="icon-func.png" class="symbol" data-cat="domini" style="top:200px; left:400px;" onclick="openPopup('Domini de funcions')">

    <!-- Par√†boles -->
    <img src="icon-func.png" class="symbol" data-cat="paraboles" style="top:300px; left:700px;" onclick="openPopup('Concavitat de par√†boles')">
    <img src="icon-func.png" class="symbol" data-cat="paraboles" style="top:420px; left:500px;" onclick="openPopup('V√®rtex de par√†boles')">
    <img src="icon-func.png" class="symbol" data-cat="paraboles" style="top:520px; left:900px;" onclick="openPopup('Intersecci√≥ de funcions')">

    <!-- L√≠mits, continu√Øtat -->
    
    <img src="icon-func.png" class="symbol" data-cat="limits" style="top:250px; left:600px;" onclick="openPopup('L√≠mits infinits')">
    <img src="icon-func.png" class="symbol" data-cat="limits" style="top:400px; left:850px;" onclick="openPopup('L√≠mits laterals')">
    <img src="icon-func.png" class="symbol" data-cat="limits" style="top:550px; left:500px;" onclick="openPopup('Continu√Øtat de funcions')">
    <img src="icon-func.png" class="symbol" data-cat="limits" style="top:300px; left:750px;" onclick="openPopup('As√≠mptotes de funcions')">

    <!-- Altres -->
    <img src="icon-func.png" class="symbol" data-cat="altres" style="top:280px; left:950px;" onclick="openPopup('Problema de la travessa des√®rtica')">
    <img src="icon-func.png" class="symbol" data-cat="altres" style="top:500px; left:300px;" onclick="openPopup('Creixents i decreixents')">
    <img src="icon-func.png" class="symbol" data-cat="altres" style="top:600px; left:600px;" onclick="openPopup('Funcions a trossos')">
    <img src="icon-func.png" class="symbol" data-cat="altres" style="top:380px; left:550px;" onclick="openPopup('Operacions entre funcions')">
    <img src="icon-func.png" class="symbol" data-cat="altres" style="top:750px; left:500px;" onclick="openPopup('Funci√≥ inversa')">
  </div>
</main>

<!-- POPUP LORE --> 
<div id="lorePopup" class="popup"> 
  <div class="popup-content lore-content"> 
    <span class="close" onclick="closeLore()">&times;</span>
    <img src="lore_F.png" alt="Pergam√≠" class="scroll-img"> 
  </div> 
</div> 

<!-- Popup -->
<div id="exercisePopup" class="popup">
  <div class="popup-content">
    <span class="close" onclick="closePopup()">&times;</span>
    <h2 id="exerciseTitle"></h2>
    <div id="exerciseContent"></div>
    <p id="feedback"></p>
  </div>
</div>

<!-- BOT√ì XAT -->
<div id="capy-toggle">
  <img src="capy.png" alt="Capy">
</div>

<!-- CHATBOT -->
<div id="capy-chat" class="hidden">
  <div class="capy-header">
    <img src="capy.png" alt="Capy">
    <span>Capy - Guia</span>
  </div>
  <div id="capy-messages">
    <div id="capy-thinking" class="hidden">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>
  </div>
  <input id="capy-input" placeholder="Pregunta a Capy...">
</div>


<script>
function toggleMenu(){document.getElementById('menu').classList.toggle('active');}
function goTo(page){window.location.href=page;}

function openLore() { 
  document.getElementById("lorePopup").style.display = "flex"; 
} 

// funci√≥ existent: tanca el popup lore
  function closeLore(){
    const lp = document.getElementById("lorePopup");
    if(lp) lp.style.display = "none";
  }

  // fallback: assegurem l'event si l'atribut onclick no s'executa per algun motiu
  document.addEventListener("DOMContentLoaded", () => {
    const closeBtn = document.querySelector(".lore-content .close");
    if(closeBtn){
      closeBtn.addEventListener("click", closeLore);
    }
    // Tamb√© fem que fer click a la capa fosca tanqui el popup (opcional)
    const lorePopup = document.getElementById("lorePopup");
    if(lorePopup){
      lorePopup.addEventListener("click", (e) => {
        if(e.target === lorePopup) closeLore(); // nom√©s si cliques fora del contingut
      });
    }
  });

function showSymbols(type){
  document.querySelectorAll(".symbol").forEach(el=>el.style.display="none");
  document.querySelectorAll(".symbol[data-cat='"+type+"']").forEach(el=>el.style.display="block");
}
document.addEventListener("DOMContentLoaded",()=>{showSymbols("domini");});
function closePopup(){document.getElementById("exercisePopup").style.display="none";}

function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function randomChoice(arr){return arr[randomInt(0,arr.length-1)];}


// ---------- CHATBOT ----------
const capyToggle = document.getElementById("capy-toggle");
const capyChat = document.getElementById("capy-chat");
const capyInput = document.getElementById("capy-input");
const capyMessages = document.getElementById("capy-messages");

capyToggle.onclick = () => capyChat.classList.toggle("hidden");

capyInput.addEventListener("keypress", async (e) => {
  if (e.key === "Enter" && capyInput.value.trim()) {
    const msg = capyInput.value.trim();
    capyMessages.innerHTML += `<p><b>Tu:</b> ${msg}</p>`;
    capyInput.value = "";

    const thinking = document.getElementById("capy-thinking");
    thinking.classList.remove("hidden");
    capyMessages.scrollTop = capyMessages.scrollHeight;

    try {
      const res = await fetch('https://mythomathic-server.onrender.com/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg }),
      });
      const data = await res.json();
      thinking.classList.add("hidden");

      capyMessages.innerHTML += `<p><b>Capy:</b> ${data.reply}</p>`;
      if(window.MathJax) MathJax.typesetPromise();
      capyMessages.scrollTop = capyMessages.scrollHeight;

    } catch (err) {
      thinking.classList.add("hidden");
      capyMessages.innerHTML += `<p><b>Capy:</b> Ups! Hi ha hagut un error al enviar el missatge.</p>`;
      capyMessages.scrollTop = capyMessages.scrollHeight;
    }
  }
});


// ====== EXERCICIS ======
const exercises = {

  // --- DOMINI ---
  "Domini de funcions":()=>{
    const exemples=[
      {text:"f(x)=3x‚Å¥+2x‚àí1", answer:"‚Ñù"},
      {text:"f(x)=(3x¬≤+x)/(x+1)", answer:"x ‚â† ‚àí1"},
      {text:"f(x)=‚àö(x¬≤‚àí25)", answer:"x ‚â§ ‚àí5 o x ‚â• 5"},
      {text:"f(x)=‚àö(x‚àí1)/(x‚àí5)", answer:"x ‚â• 1, x ‚â† 5"},
      {text:"f(x)=ln(x+2)", answer:"x > ‚àí2"},
    ];
    const ex=randomChoice(exemples);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Troba el domini de:</p>
      <p><b>${ex.text}</b></p>
      <input id="answer1" placeholder="Ex: x ‚â† ‚àí1 o x ‚â• 0">
      <button onclick="checkTextAnswers(['${ex.answer}'])">Comprovar</button>
      <button onclick="exercises['Domini de funcions']()">Nova activitat</button>`;
  },

  // --- PAR√ÄBOLES ---
  "Concavitat de par√†boles":()=>{
    const casos=[
      {eq:"y=2x¬≤‚àí2x+1", answer:"convexa"},
      {eq:"y=‚àíx¬≤+5x‚àí2", answer:"c√≤ncava"},
      {eq:"y=1‚àíx¬≤", answer:"c√≤ncava"},
      {eq:"y=1‚àí3x+2x¬≤", answer:"convexa"}
    ];
    const c=randomChoice(casos);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Indica si la par√†bola √©s c√≤ncava o convexa:</p>
      <b>${c.eq}</b><br><br>
      <input id="answer1" placeholder="Escriu c√≤ncava o convexa">
      <button onclick="checkTextAnswers(['${c.answer}'])">Comprovar</button>
      <button onclick="exercises['Concavitat de par√†boles']()">Nova activitat</button>`;
  },

  "V√®rtex de par√†boles":()=>{
    const casos=[
      {eq:"y=x¬≤+2x‚àí8", h:-1, k:-9},
      {eq:"y=‚àíx¬≤+7x‚àí10", h:3.5, k:2.25},
      {eq:"y=3x‚àí2x¬≤", h:0.75, k:1.12}
    ];
    const c=randomChoice(casos);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Troba el v√®rtex de:</p><b>${c.eq}</b><br><br>
      <input id="answer1" placeholder="x del v√®rtex">
      <input id="answer2" placeholder="y del v√®rtex">
      <button onclick="checkDoubleAnswer(${c.h},${c.k})">Comprovar</button>
      <button onclick="exercises['V√®rtex de par√†boles']()">Nova activitat</button>`;
  },

  // üîπ INTERSECCI√ì DE FUNCIONS
  "Intersecci√≥ de funcions":()=>{
    const a=randomInt(1,3);
    const b=randomInt(-4,4);
    const c=randomInt(-5,5);
    const m=randomInt(-3,3);
    const n=randomInt(-5,5);

    const A=a;
    const B=b-m;
    const C=c-n;
    const disc=B*B-4*A*C;

    let result;
    if(disc<0){
      result="No hi ha intersecci√≥ real.";
    } else if(disc===0){
      const x=(-B/(2*A)).toFixed(2);
      result=`x=${x}`;
    } else {
      const x1=((-B+Math.sqrt(disc))/(2*A)).toFixed(2);
      const x2=((-B-Math.sqrt(disc))/(2*A)).toFixed(2);
      result=`x=${x1} i x=${x2}`;
    }

    document.getElementById("exerciseContent").innerHTML=`
      <p>Troba els punts d‚Äôintersecci√≥ de:</p>
      <p><b>y=${a}x¬≤${b>=0?'+':''}${b}x${c>=0?'+':''}${c}</b></p>
      <p><b>y=${m}x${n>=0?'+':''}${n}</b></p>
      <input id="answer1" placeholder="Valors de x">
      <button onclick="checkTextAnswers(['${result}'])">Comprovar</button>
      <button onclick="exercises['Intersecci√≥ de funcions']()">Nova activitat</button>`;
  },

  // üîπ PROBLEMA ‚Äî mateix format que el del Cam√≠ de Santiago
  "Problema de la travessa des√®rtica":()=>{
    const dist=randomInt(650,900);  // km totals
    const minDays=randomInt(25,40);
    const kmDia1=randomInt(20,28);
    const kmDia2=randomInt(29,40);
    const temps=(dist/kmDia2).toFixed(2);

    document.getElementById("exerciseContent").innerHTML=`
      <p>Per completar els <b>${dist} km</b> de la travessa des√®rtica del Sahel, cal rec√≥rrer <b>${kmDia1} km</b> diaris durant un m√≠nim de <b>${minDays} dies</b>.</p>
      <p><b>1)</b> Troba la funci√≥ que proporciona el nombre de dies que calen per fer tota la travessa en funci√≥ dels quil√≤metres que es recorren cada dia.</p>
      <p><b>2)</b> Determina, a partir de la funci√≥ que has trobat, el temps que es trigaria a rec√≥rrer el desert a un ritme de <b>${kmDia2} km</b> diaris.</p>

      <input id="answer1" placeholder="Ex: t(v)=700/v">
      <input id="answer2" placeholder="Ex: 23.3">

      <button onclick="checkTextAnswers(['t(v)=${dist}/v'])">Comprovar funci√≥</button>
      <button onclick="checkAnswer(${temps})">Comprovar resultat</button>
      <button onclick="exercises['Problema de la travessa des√®rtica']()">Nova activitat</button>`;
  },

  "Operacions entre funcions":()=>{
    const a=randomInt(1,5), b=randomInt(1,6), c=randomInt(1,4), d=randomInt(0,5);
    const f=`f(x)=${a}x+${b}`;
    const g=`g(x)=${c}x+${d}`;
    const ops=[
      {sim:"+", fn:(x)=>`${a+c}x+${b+d}`},
      {sim:"‚àí", fn:(x)=>`${a-c}x+${b-d}`},
      {sim:"¬∑", fn:(x)=>`${a*c}x¬≤+${a*d+b*c}x+${b*d}`},
      {sim:"√∑", fn:(x)=>`(${a}x+${b})/(${c}x+${d})`}
    ];
    const op=randomChoice(ops);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Sigui ${f} i ${g}.</p>
      <p>Calcula <b>f(x) ${op.sim} g(x)</b></p>
      <input id="answer1" placeholder="Resultat">
      <button onclick="checkTextAnswers(['${op.fn()}'])">Comprovar</button>
      <button onclick="exercises['Operacions entre funcions']()">Nova activitat</button>`;
  },

  "Creixents i decreixents":()=>{
    const fns=[
      {eq:"y=8^x", ans:"creixent"},
      {eq:"y=0.6^x", ans:"decreixent"},
      {eq:"y=log‚ÇÄ.‚ÇÇ(x)", ans:"decreixent"},
      {eq:"y=log‚ÇÖ(x)", ans:"creixent"}
    ];
    const c=randomChoice(fns);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Indica si la funci√≥ √©s creixent o decreixent:</p>
      <b>${c.eq}</b><br><br>
      <input id="answer1" placeholder="creixent o decreixent">
      <button onclick="checkTextAnswers(['${c.ans}'])">Comprovar</button>
      <button onclick="exercises['Creixents i decreixents']()">Nova activitat</button>`;
  },

  "Funcions a trossos":()=>{
    const fns=[
      {eq:"f(x)=5‚àí|x|", ans:"x‚â•0:5‚àíx; x<0:5+x"},
      {eq:"f(x)=x¬∑|x|", ans:"x‚â•0:x¬≤; x<0:‚àíx¬≤"},
      {eq:"f(x)=|x+2|‚àíx", ans:"x‚â•‚àí2:2; x<‚àí2:‚àí2‚àí2x"}
    ];
    const c=randomChoice(fns);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Escriu com a funci√≥ definida a trossos:</p>
      <b>${c.eq}</b><br><br>
      <input id="answer1" placeholder="Defineix els trams">
      <button onclick="checkTextAnswers(['${c.ans}'])">Comprovar</button>
      <button onclick="exercises['Funcions a trossos']()">Nova activitat</button>`;
  },

  "Funci√≥ inversa":()=>{
    const fns=[
      {eq:"f(x)=3x+4", inv:"(x‚àí4)/3"},
      {eq:"f(x)=(x‚àí1)/2", inv:"2x+1"},
      {eq:"f(x)=(5x‚àí2)/x", inv:"2/(5‚àíx)"},
      {eq:"f(x)=(3x‚àí2)/(2x+7)", inv:"(7x+2)/(3‚àí2x)"}
    ];
    const c=randomChoice(fns);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Calcula la funci√≥ inversa de:</p>
      <b>${c.eq}</b><br><br>
      <input id="answer1" placeholder="f‚Åª¬π(x)">
      <button onclick="checkTextAnswers(['${c.inv}'])">Comprovar</button>
      <button onclick="exercises['Funci√≥ inversa']()">Nova activitat</button>`;
  },

  // üîπ L√çMITS I CONTINU√èTAT üîπ
  "L√≠mits infinits":()=>{
    const sentit = Math.random() < 0.5 ? "+‚àû" : "‚àí‚àû"; // alterna el sentit
    const exemples = [
      {expr:"x¬≤ - 2x¬≤ + 3", ans:(sentit==="+‚àû"?"‚àí‚àû":"‚àí‚àû")},
      {expr:"(12/x) - 1", ans:(sentit==="+‚àû"?"‚àí1":"‚àí1")},
      {expr:"(12x‚àí5)/(3x+5)", ans:(sentit==="+‚àû"?"4":"4")},
      {expr:"(x¬≤+x+1)/(10x)", ans:(sentit==="+‚àû"?"‚àû":"‚àí‚àû")},
      {expr:"‚àö(4x¬≤‚àí1)/(2x)", ans:(sentit==="+‚àû"?"1":"‚àí1")}
    ];
    const ex = randomChoice(exemples);

    document.getElementById("exerciseContent").innerHTML = `
      <p>Calcula el l√≠mit quan <b>x ‚Üí ${sentit}</b> de la funci√≥ seg√ºent:</p>
      <p><b>lim x‚Üí${sentit} (${ex.expr})</b></p>
      <input id="answer1" placeholder="Ex: 4, ‚àû, ‚àí‚àû, 1...">
      <button onclick="checkTextAnswers(['${ex.ans}'])">Comprovar</button>
      <button onclick="exercises['L√≠mits infinits']()">Nova activitat</button>
    `;
  },

  "L√≠mits laterals":()=>{
    const exemples=[
      {text:"lim x‚Üí0‚Åª (1/x)", ans:"‚àí‚àû"},
      {text:"lim x‚Üí0‚Å∫ (1/x)", ans:"+‚àû"},
      {text:"lim x‚Üí1‚Åª (1/x¬≤)", ans:"1"},
      {text:"lim x‚Üí1‚Å∫ (1/x¬≤)", ans:"1"},
      {text:"lim x‚Üí2‚Åª ((x¬≤‚àí4)/(3x‚àí6))", ans:"4/3"},
      {text:"lim x‚Üí2‚Å∫ ((x¬≤‚àí4)/(3x‚àí6))", ans:"4/3"},
      {text:"lim x‚Üí4‚Åª (x/(‚àöx‚àí2))", ans:"+‚àû"},
      {text:"lim x‚Üí4‚Å∫ (x/(‚àöx‚àí2))", ans:"‚àí‚àû"}
    ];
    const ex=randomChoice(exemples);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Calcula el l√≠mit lateral seg√ºent:</p>
      <b>${ex.text}</b><br><br>
      <input id="answer1" placeholder="Ex: +‚àû o ‚àí‚àû">
      <button onclick="checkTextAnswers(['${ex.ans}'])">Comprovar</button>
      <button onclick="exercises['L√≠mits laterals']()">Nova activitat</button>`;
  },

  "Continu√Øtat de funcions":()=>{
    const exemples=[
      {text:"f(x) = (x‚àí4)/(x+2)", ans:"x = ‚àí2"},
      {text:"f(x) = (x+1)/(x¬≤‚àíx‚àí6)", ans:"x = 3, x = ‚àí2"},
      {text:"f(x) = (x¬≤+2)/(x¬≥+3x¬≤‚àí4x)", ans:"x = 0, x = 1, x = ‚àí4"},
      {text:"f(x) = (x¬≤‚àí1)/(x¬≤‚àí3x+2x)", ans:"x = 0, x = 1"}
    ];
    const ex=randomChoice(exemples);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Indica en quins punts la funci√≥ no √©s cont√≠nua:</p>
      <b>${ex.text}</b><br><br>
      <input id="answer1" placeholder="Ex: x = 1, x = ‚àí2">
      <button onclick="checkTextAnswers(['${ex.ans}'])">Comprovar</button>
      <button onclick="exercises['Continu√Øtat de funcions']()">Nova activitat</button>`;
  },

  "As√≠mptotes de funcions":()=>{
    const exemples=[
      {text:"f(x) = x / (x¬≤‚àí5x+4)", ans:"x=1, x=4 (verticals); y=0 (horitzontal)"},
      {text:"f(x) = x¬≤ / (x¬≤‚àí4)", ans:"x=2, x=‚àí2 (verticals); y=1 (horitzontal)"},
      {text:"f(x) = (4x¬≤‚àí2)/x", ans:"x=0 (vertical); y=‚àû (obliqua)"},
      {text:"f(x) = (5x¬≤‚àí5)/(2x¬≤+x‚àí1)", ans:"x=0.5, x=‚àí1 (verticals); y=5/2 (horitzontal)"}
    ];
    const ex=randomChoice(exemples);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Troba les as√≠mptotes de la funci√≥ i indica si s√≥n horitzontals, verticals o obliq√ºes:</p>
      <b>${ex.text}</b><br><br>
      <input id="answer1" placeholder="Ex: x=1, y=0">
      <button onclick="checkTextAnswers(['${ex.ans}'])">Comprovar</button>
      <button onclick="exercises['As√≠mptotes de funcions']()">Nova activitat</button>`;
  }
};


// ====== FUNCIONS DE COMPROVACI√ì ======
function openPopup(title){
  document.getElementById("exerciseTitle").textContent=title;
  document.getElementById("exercisePopup").style.display="flex";
  if(exercises[title]) exercises[title]();
  else document.getElementById("exerciseContent").innerHTML="<p>No disponible.</p>";
  document.getElementById("feedback").textContent="";
}

function checkAnswer(correct){
  const user=parseFloat(document.getElementById("answer2")?.value || document.getElementById("answer1")?.value);
  const fb=document.getElementById("feedback");
  if(Math.abs(user-correct)<0.1){fb.innerHTML="‚úÖ Correcte!"; onExerciseCorrect();}
  else fb.innerHTML=`‚ùå Incorrecte (esperat ${correct})`;
}

function checkDoubleAnswer(correct1,correct2){
  const u1=parseFloat(document.getElementById("answer1").value);
  const u2=parseFloat(document.getElementById("answer2").value);
  const fb=document.getElementById("feedback");
  if(Math.abs(u1-correct1)<0.2 && Math.abs(u2-correct2)<0.2){
    fb.innerHTML="‚úÖ Correcte!";
    onExerciseCorrect();
  } else fb.innerHTML=`‚ùå Incorrecte (esperat V(${correct1},${correct2}))`;
}

function checkTextAnswers(expected){
  const fb=document.getElementById("feedback");
  const ans=document.getElementById("answer1").value.trim().replace(/\s+/g,'').toLowerCase();
  const correct=expected[0].replace(/\s+/g,'').toLowerCase();
  if(ans===correct){
    fb.innerHTML="‚úÖ Correcte!";
    onExerciseCorrect();
  } else fb.innerHTML=`‚ùå Incorrecte (esperat ${expected[0]})`;
}


// ================== EXPERI√àNCIA =====================
let correctExercises=0;
let xp=parseInt(localStorage.getItem("xp"))||0;
let level=parseInt(localStorage.getItem("level"))||1;
let xpGainBase=50;

function addXP(amount){
  xp+=amount;
  const xpMax=level*100;
  if(xp>=xpMax){ xp-=xpMax; level++; gainTitle(level); }
  localStorage.setItem("xp",xp);
  localStorage.setItem("level",level);
  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);
}
function gainTitle(level){
  const titles={
    1:"Custodi del Flux",2:"Guardi√† del Patr√≥",3:"Savi d‚ÄôEkuatia",
    4:"Somniador de Tangentia",5:"Vigilant de Complexia",
    6:"Cercador de Functonia",7:"Mestre de Derivalia"
  };
  const newTitle=titles[level]||`Aventurer Nivell ${level}`;
  alert(`‚ú® Has pujat de nivell! Nou t√≠tol: ${newTitle}`);
  localStorage.setItem("title",newTitle);
}
function onExerciseCorrect(){
  correctExercises++;
  if(correctExercises%5===0){
    const earnedXP=Math.max(10,xpGainBase-(level-1)*5);
    addXP(earnedXP);
  }
}
</script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// üîπ Configuraci√≥ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDPVUQZXaSAARwROsDgvlohMvB-esYvMrA",
  authDomain: "mythomathic.firebaseapp.com",
  projectId: "mythomathic",
  storageBucket: "mythomathic.firebasestorage.app",
  messagingSenderId: "396574593247",
  appId: "1:396574593247:web:5b7f02c53de5613eda996a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

// üîπ Quan l‚Äôusuari est√† autenticat, recuperem el seu XP actual
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    const ref = doc(db, "users", user.uid);
    const snapshot = await getDoc(ref);
    if (snapshot.exists()) {
      const data = snapshot.data();
      xp = data.xp || 0;
      level = data.level || 1;
      localStorage.setItem("xp", xp);
      localStorage.setItem("level", level);
    }
  } else {
    console.warn("Usuari no autenticat ‚Äî XP nom√©s local.");
  }
});

// üîπ Funci√≥ per sincronitzar XP amb la base de dades
async function updateXPInDB(newXP, newLevel) {
  if (!currentUser) return;
  try {
    await updateDoc(doc(db, "users", currentUser.uid), {
      xp: newXP,
      level: newLevel
    });
    console.log("‚úÖ XP actualitzat al n√∫vol:", newXP, "nivell:", newLevel);
  } catch (err) {
    console.error("‚ùå Error actualitzant XP a Firestore:", err);
  }
}

// ‚ú® Modifica la funci√≥ addXP perqu√® actualitzi Firebase tamb√©
window.addXP = async function(amount) {
  xp += amount;
  const xpMax = level * 100;
  if (xp >= xpMax) {
    xp -= xpMax;
    level++;
    gainTitle(level);
  }

  localStorage.setItem("xp", xp);
  localStorage.setItem("level", level);

  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);

  await updateXPInDB(xp, level);
};
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
 src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

</body>
</html>










