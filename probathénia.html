<!DOCTYPE html> 
<html lang="ca"> 
    <head> 
        <meta charset="UTF-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <title>Probath√©nia - Mythomathic</title> 
        <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"> 
        <link rel="stylesheet" href="probath√©nia.css"> 
    </head> 
<body> 
    <header> 
<button class="back-button" onclick="goTo('map.html')">‚¨Ö Mapa</button> 
<div class="title-center"> 
<img src="P_Title.png" alt="Probath√©nia" class="title-img"> 
</div> 
<div class="header-buttons"> 
    <button onclick="openLore()">üìú Lore</button> 
    <button onclick="toggleMenu()">‚ò∞ Men√∫</button> 
</div> 
<nav id="menu"> 
    <ul> <li onclick="goTo('map.html')">Mapa</li> 
        <li onclick="goTo('perfil.html')">Perfil</li> 
        <li onclick="goTo('config.html')">Configuraci√≥</li> 
        <li onclick="goTo('sobremi.html')">Sobre mi</li> 
        <li onclick="goTo('contacte.html')">Contacte</li> 
    </ul> 
</nav> 
</header> 

<main class="dimension-container">
  <aside class="categories">
    <button onclick="showSymbols('espai')">Espai mostral</button>
    <button onclick="showSymbols('combinatoria')">Combinat√≤ria & factorials</button>
    <button onclick="showSymbols('esdeveniments')">Esdeveniments & probabilitats</button>
    <button onclick="showSymbols('composta')">Probabilitat composta / Bayes</button>
  </aside>

  <div class="symbols">
    <!-- Espai mostral -->
    <img src="icon-pro.png" class="symbol" data-cat="espai" style="top:200px; left:700px;" onclick="openPopup('Espai mostral')">
    <img src="icon-pro.png" class="symbol" data-cat="espai" style="top:350px; left:600px;" onclick="openPopup('Espai mostral 2 monedes')">

    <!-- Combinat√≤ria -->
    <img src="icon-pro.png" class="symbol" data-cat="combinatoria" style="top:200px; left:600px;" onclick="openPopup('Combinat√≤ria i combinacions')">
    <img src="icon-pro.png" class="symbol" data-cat="combinatoria" style="top:400px; left:700px;" onclick="openPopup('Simplificaci√≥ factorials')">

    <!-- Esdeveniments -->
    <img src="icon-pro.png" class="symbol" data-cat="esdeveniments" style="top:200px; left:860px;" onclick="openPopup('Verdader o fals')">
    <img src="icon-pro.png" class="symbol" data-cat="esdeveniments" style="top:350px; left:650px;" onclick="openPopup('Urna m√†gica')">
    <img src="icon-pro.png" class="symbol" data-cat="esdeveniments" style="top:500px; left:750px;" onclick="openPopup('Peixos m√†gics')">
    <img src="icon-pro.png" class="symbol" data-cat="esdeveniments" style="top:550px; left:500px;" onclick="openPopup('Esdeveniments A B')">

    <!-- Composta / Bayes -->
    <img src="icon-pro.png" class="symbol" data-cat="composta" style="top:400px; left:800px;" onclick="openPopup('Teorema de Bayes')">
    <img src="icon-pro.png" class="symbol" data-cat="composta" style="top:550px; left:600px;" onclick="openPopup('Probabilitat Laplace & distribuci√≥')">
  </div>
</main>

<!-- POPUP LORE --> 
<div id="lorePopup" class="popup"> 
  <div class="popup-content lore-content"> 
    <span class="close" onclick="closeLore()">&times;</span>
    <img src="lore_R.png" alt="Pergam√≠" class="scroll-img"> 
  </div> 
</div>

<div id="exercisePopup" class="popup">
  <div class="popup-content">
    <span class="close" onclick="closePopup()">&times;</span>
    <h2 id="exerciseTitle"></h2>
    <div id="exerciseContent"></div>
    <p id="feedback"></p>
  </div>
</div>

<!-- CHATBOT -->
<div id="capy-toggle">
  <img src="capy.png" alt="Capy">
</div>

<div id="capy-chat" class="hidden">
  <div class="capy-header">
    <img src="capy.png" alt="Capy">
    <span>Capy - Guia</span>
  </div>
  <div id="capy-messages"></div>
  <input id="capy-input" placeholder="Pregunta a Capy...">
  <div id="capy-thinking" class="hidden">
  <span class="dot"></span>
  <span class="dot"></span>
  <span class="dot"></span>
</div>
</div>

<script>
function toggleMenu() { 
  document.getElementById('menu').classList.toggle('active'); 
} 

function goTo(page) { 
  window.location.href = page; 
} 

function openLore() { 
  document.getElementById("lorePopup").style.display = "flex"; 
} 



// funci√≥ existent: tanca el popup lore
  function closeLore(){
    const lp = document.getElementById("lorePopup");
    if(lp) lp.style.display = "none";
  }

  // fallback: assegurem l'event si l'atribut onclick no s'executa per algun motiu
  document.addEventListener("DOMContentLoaded", () => {
    const closeBtn = document.querySelector(".lore-content .close");
    if(closeBtn){
      closeBtn.addEventListener("click", closeLore);
    }
    // Tamb√© fem que fer click a la capa fosca tanqui el popup (opcional)
    const lorePopup = document.getElementById("lorePopup");
    if(lorePopup){
      lorePopup.addEventListener("click", (e) => {
        if(e.target === lorePopup) closeLore(); // nom√©s si cliques fora del contingut
      });
    }
  });



function showSymbols(cat){
  document.querySelectorAll('.symbol').forEach(s=>s.style.display='none');
  document.querySelectorAll(`.symbol[data-cat="${cat}"]`).forEach(s=>s.style.display='block');
}
document.addEventListener('DOMContentLoaded',()=>showSymbols('espai'));
function closePopup(){document.getElementById('exercisePopup').style.display='none';}
function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function randomChoice(arr){return arr[Math.floor(Math.random()*arr.length)];}
function factorial(n){return n<=1?1:n*factorial(n-1);}

function checkTextAnswers(expected) {
  const user = document.getElementById("answer1")?.value.trim().toLowerCase().replace(/\s+/g, '');
  const valid = expected.map(e => e.toLowerCase().replace(/\s+/g, ''));
  const fb = document.getElementById("feedback");

  if (valid.includes(user)) {
    fb.innerHTML = "‚úÖ Correcte!";
    fb.style.color = "green";
    onExerciseCorrect(); // ‚úÖ guanya XP i compta exercici correcte
  } else {
    fb.innerHTML = `‚ùå Incorrecte (resposta correcta: ${expected[0]})`;
    fb.style.color = "red";
  }
}


/* ---------- CHATBOT ---------- */
const capyToggle = document.getElementById("capy-toggle");
const capyChat = document.getElementById("capy-chat");
const capyInput = document.getElementById("capy-input");
const capyMessages = document.getElementById("capy-messages");

capyToggle.onclick = () => capyChat.classList.toggle("hidden");

capyInput.addEventListener("keypress", async (e) => {
  if (e.key === "Enter" && capyInput.value.trim()) {
    const msg = capyInput.value.trim();
    capyMessages.innerHTML += `<p><b>Tu:</b> ${msg}</p>`;
    capyInput.value = "";

    // MOSTREM punts de pensament
    const thinking = document.getElementById("capy-thinking");
    thinking.classList.remove("hidden");

    // Enviem el missatge al servidor
    try {
      const res = await fetch('https://mythomathic-server.onrender.com/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg }),
      });

      const data = await res.json();

      // OCULTEM punts quan arriba la resposta
      thinking.classList.add("hidden");

      // Afegim missatge de Capy amb s√≠mbols matem√†tics
      capyMessages.innerHTML += `<p><b>Capy:</b> ${data.reply}</p>`;
      MathJax.typesetPromise();
      capyMessages.scrollTop = capyMessages.scrollHeight;

    } catch (err) {
      thinking.classList.add("hidden"); // assegurem amagar punts si hi ha error
      capyMessages.innerHTML += `<p><b>Capy:</b> Ups! Hi ha hagut un error al enviar el missatge.</p>`;
      capyMessages.scrollTop = capyMessages.scrollHeight;
    }
  }
});


// ===== Exercicis =====
const exercises={

  // ESPAI MOSTRAL
  "Espai mostral":()=>{
    const exemples=[
      {text:"Llen√ßar un dau de 6 cares",ans:"{1,2,3,4,5,6}"},
      {text:"Llen√ßar un dau de 8 cares",ans:"{1,2,3,4,5,6,7,8}"},
      {text:"Treure una carta d'una baralla espanyola (sense oros)",ans:"{copas,bastos,espases}"},
      {text:"Treure una bola d‚Äôuna urna amb 3 boles numerades del 1 al 3",ans:"{1,2,3}"},
      {text:"Llan√ßar dues monedes",ans:"{CC,CX,XC,XX}"}
    ];
    const ex=randomChoice(exemples);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Escriu l‚Äôespai mostral de l‚Äôexperiment:</p>
      <b>${ex.text}</b><br><br>
      <input id="answer1" placeholder="Ex: {‚Ä¶}">
      <button onclick="checkTextAnswers(['${ex.ans}'])">Comprovar</button>
      <button onclick="exercises['Espai mostral']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  "Espai mostral 2 monedes":()=>{
    const ans="{CC,CX,XC,XX}";
    document.getElementById("exerciseContent").innerHTML=`
      <p>Llan√ßa dues monedes. Quin √©s l'espai mostral?</p>
      <input id="answer1" placeholder="Ex: {‚Ä¶}">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Espai mostral 2 monedes']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // PEIXOS M√ÄGICS (ara a esdeveniments)
  "Peixos m√†gics":()=>{
    const blau=randomInt(2,6), daurats=randomInt(1,5), escarlates=randomInt(1,4);
    const total=blau+daurats+escarlates;
    const ans=`blau=${(blau/total).toFixed(2)},daurat=${(daurats/total).toFixed(2)},escarlata=${(escarlates/total).toFixed(2)}`;
    document.getElementById("exerciseContent").innerHTML=`
      <p>Passejant per Probath√©nia trobes el riu Aqualis, on viuen ${blau} peixos blaus, ${daurats} daurats i ${escarlates} escarlates.</p>
      <p>Si n'agafes un a l‚Äôatzar, escriu la probabilitat de cada esp√®cie.</p>
      <input id="answer1" placeholder="Ex: blau=...,daurat=...,escarlata=...">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Peixos m√†gics']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // COMBINAT√íRIA
  "Combinat√≤ria i combinacions":()=>{
    const tipus=randomChoice(["V","VR","P","C","F"]);
    let pregunta="",res="";
    if(tipus==="V"){const n=randomInt(6,10),r=randomInt(2,n-1);pregunta=`Calcula V${n},${r}`;res=(factorial(n)/factorial(n-r)).toFixed(0);}
    if(tipus==="VR"){const n=randomInt(6,10),r=randomInt(2,n-1);pregunta=`Calcula VR${n},${r}`;res=Math.pow(n,r);}
    if(tipus==="P"){const n=randomInt(4,8);pregunta=`Calcula P${n}`;res=factorial(n);}
    if(tipus==="C"){const n=randomInt(6,10),r=randomInt(2,n-1);pregunta=`Calcula C${n},${r}`;res=(factorial(n)/(factorial(r)*factorial(n-r))).toFixed(0);}
    if(tipus==="F"){const n=randomChoice([5,10]);pregunta=`Calcula ${n}!`;res=factorial(n);}
    document.getElementById("exerciseContent").innerHTML=`
      <p>${pregunta}</p>
      <input id="answer1" placeholder="Resultat">
      <button onclick="checkTextAnswers(['${res}'])">Comprovar</button>
      <button onclick="exercises['Combinat√≤ria i combinacions']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  "Simplificaci√≥ factorials":()=>{
    const exemples=[
      {t:"11! / 7!",r:factorial(11)/factorial(7)},
      {t:"18! / 15!",r:factorial(18)/factorial(15)},
      {t:"6!7! / 3!4!",r:(factorial(6)*factorial(7))/(factorial(3)*factorial(4))},
      {t:"(n+2)! / (n-2)!",r:"n(n‚àí1)(n+1)(n+2)"},
      {t:"P5P7 / 8!",r:(factorial(5)*factorial(7))/factorial(8)}
    ];
    const ex=randomChoice(exemples);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Simplifica:</p><b>${ex.t}</b><br>
      <input id="answer1" placeholder="Resultat">
      <button onclick="checkTextAnswers(['${ex.r}'])">Comprovar</button>
      <button onclick="exercises['Simplificaci√≥ factorials']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // ESDEVENIMENTS
  "Verdader o fals":()=>{
    const tipusDau=randomChoice([4,6,8,10]);
    const ens=[
      {text:`Tens un dau de ${tipusDau} cares. √âs impossible que surti un ${tipusDau+1}.`,ans:"Vertader"},
      {text:`Tens un dau de ${tipusDau} cares. √âs segur que sortir√† un nombre m√©s petit que ${tipusDau+1}.`,ans:"Vertader"},
      {text:`Tens un dau de ${tipusDau} cares. √âs possible treure un 0.`,ans:"Fals"},
      {text:`Tens un dau de ${tipusDau} cares. El contrari a sortir parell √©s sortir imparell.`,ans:"Vertader"},
      {text:`Tens un dau de ${tipusDau} cares. √âs possible que surtin 1 i ${tipusDau} alhora.`,ans:"Fals"}
    ];
    const ex=randomChoice(ens);
    document.getElementById("exerciseContent").innerHTML=`
      <p>${ex.text}</p>
      <select id="answer1">
        <option value="">--Selecciona--</option>
        <option value="Vertader">Vertader</option>
        <option value="Fals">Fals</option>
      </select>
      <button onclick="checkTextAnswers(['${ex.ans}'])">Comprovar</button>
      <button onclick="exercises['Verdader o fals']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  "Urna m√†gica":()=>{
    const colors=["llum","ombra","aigua","foc"];
    const nums=colors.map(()=>randomInt(2,8));
    const total=nums.reduce((a,b)=>a+b,0);
    const probs=colors.map((c,i)=>`${c}=${(nums[i]/total).toFixed(2)}`).join(',');
    document.getElementById("exerciseContent").innerHTML=`
      <p>En una urna m√†gica hi ha cristalls: ${colors.map((c,i)=>`${nums[i]} de ${c}`).join(', ')}.</p>
      <p>Calcula la probabilitat de treure cada tipus.</p>
      <input id="answer1" placeholder="llum=...,ombra=...,aigua=...,foc=...">
      <button onclick="checkTextAnswers(['${probs}'])">Comprovar</button>
      <button onclick="exercises['Urna m√†gica']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  "Esdeveniments A B":()=>{
    const univers=[1,2,3,4,5,6,7,8,9];
    const A=new Set(randomChoice([[1,3,5],[2,4,6],[1,2,3,7]]));
    const B=new Set(randomChoice([[2,3,4,5],[5,6,7],[1,4,6,8]]));
    const unionAB=[...new Set([...A,...B])].sort().join(',');
    const interAB=[...A].filter(x=>B.has(x)).sort().join(',');
    const diff=[...A].filter(x=>!B.has(x)).sort().join(',');
    const ans=`A‚ãÉB={${unionAB}}|A‚ãÇB={${interAB}}|A‚àíB={${diff}}`;
    document.getElementById("exerciseContent").innerHTML=`
      <p>A=${JSON.stringify([...A])}, B=${JSON.stringify([...B])}</p>
      <p>Troba A‚ãÉB, A‚ãÇB i A‚àíB.</p>
      <input id="answer1" placeholder="A‚ãÉB={‚Ä¶}|A‚ãÇB={‚Ä¶}|A‚àíB={‚Ä¶}">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Esdeveniments A B']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // COMPOSTA / BAYES
  "Teorema de Bayes":()=>{
    const pA=randomInt(1,9)/10;
    const pB_A=randomInt(3,9)/10;
    const pB_noA=randomInt(1,5)/10;
    const ans=((pB_A*pA)/(pB_A*pA+pB_noA*(1-pA))).toFixed(2);
    document.getElementById("exerciseContent").innerHTML=`
      <p>P(A)=${pA}, P(B|A)=${pB_A}, P(B|¬¨A)=${pB_noA}</p>
      <p>Calcula P(A|B)</p>
      <input id="answer1" placeholder="Ex: 0.42">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Teorema de Bayes']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  "Probabilitat Laplace & distribuci√≥":()=>{
  const tipus=randomChoice(["dau","urna","monedes"]);

  if(tipus==="dau"){
    const cares=randomInt(4,12);
    const numero=randomInt(1,cares);
    const p=1/cares;
    const ans=p.toFixed(2);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Dau de ${cares} cares. Probabilitat de treure un ${numero}?</p>
      <input id="answer1" placeholder="Ex: 0.17">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Probabilitat Laplace & distribuci√≥']()">Nova activitat</button>`;
  }

  else if(tipus==="urna"){
    const b=randomInt(3,8), n=randomInt(2,6), v=randomInt(1,4);
    const total=b+n+v;
    const ans=`b=${(b/total).toFixed(2)},n=${(n/total).toFixed(2)},v=${(v/total).toFixed(2)}`;
    document.getElementById("exerciseContent").innerHTML=`
      <p>Urna amb ${b} cristalls blaus, ${n} negres i ${v} verds. Calcula la probabilitat de treure cadascun.</p>
      <input id="answer1" placeholder="b=...,n=...,v=...">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Probabilitat Laplace & distribuci√≥']()">Nova activitat</button>`;
  }

  else { // monedes
    const monedes=randomInt(2,4);
    const total=Math.pow(2,monedes);
    const ans=(1/total).toFixed(2);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Llances ${monedes} monedes. Probabilitat que surtin totes cares?</p>
      <input id="answer1" placeholder="Ex: 0.25">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Probabilitat Laplace & distribuci√≥']()">Nova activitat</button>`;
  }

  document.getElementById("feedback").innerHTML="";
}
};


// === Popup handler ===
function openPopup(title){
  const popup = document.getElementById("exercisePopup");
  popup.classList.add("active");
  document.getElementById("exerciseTitle").innerText = title;
  if (exercises[title]) exercises[title]();
}

function closePopup(){
  document.getElementById("exercisePopup").classList.remove("active");
}


// ================== EXPERI√àNCIA =====================
let correctExercises=0;
let xp=parseInt(localStorage.getItem("xp"))||0;
let level=parseInt(localStorage.getItem("level"))||1;
let xpGainBase=50;

function addXP(amount){
  xp+=amount;
  const xpMax=level*100;
  if(xp>=xpMax){ xp-=xpMax; level++; gainTitle(level); }
  localStorage.setItem("xp",xp);
  localStorage.setItem("level",level);
  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);
}
function gainTitle(level){
  const titles={
    1:"Custodi del Flux",2:"Guardi√† del Patr√≥",3:"Savi d‚ÄôEkuatia",
    4:"Somniador de Tangentia",5:"Vigilant de Complexia",
    6:"Cercador de Functonia",7:"Mestre de Derivalia"
  };
  const newTitle=titles[level]||`Aventurer Nivell ${level}`;
  alert(`‚ú® Has pujat de nivell! Nou t√≠tol: ${newTitle}`);
  localStorage.setItem("title",newTitle);
}
function onExerciseCorrect(){
  correctExercises++;
  if(correctExercises%5===0){
    const earnedXP=Math.max(10,xpGainBase-(level-1)*5);
    addXP(earnedXP);
  }
}
</script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// üîπ Configuraci√≥ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDPVUQZXaSAARwROsDgvlohMvB-esYvMrA",
  authDomain: "mythomathic.firebaseapp.com",
  projectId: "mythomathic",
  storageBucket: "mythomathic.firebasestorage.app",
  messagingSenderId: "396574593247",
  appId: "1:396574593247:web:5b7f02c53de5613eda996a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

// üîπ Quan l‚Äôusuari est√† autenticat, recuperem el seu XP actual
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    const ref = doc(db, "users", user.uid);
    const snapshot = await getDoc(ref);
    if (snapshot.exists()) {
      const data = snapshot.data();
      xp = data.xp || 0;
      level = data.level || 1;
      localStorage.setItem("xp", xp);
      localStorage.setItem("level", level);
    }
  } else {
    console.warn("Usuari no autenticat ‚Äî XP nom√©s local.");
  }
});

// üîπ Funci√≥ per sincronitzar XP amb la base de dades
async function updateXPInDB(newXP, newLevel) {
  if (!currentUser) return;
  try {
    await updateDoc(doc(db, "users", currentUser.uid), {
      xp: newXP,
      level: newLevel
    });
    console.log("‚úÖ XP actualitzat al n√∫vol:", newXP, "nivell:", newLevel);
  } catch (err) {
    console.error("‚ùå Error actualitzant XP a Firestore:", err);
  }
}

// ‚ú® Modifica la funci√≥ addXP perqu√® actualitzi Firebase tamb√©
window.addXP = async function(amount) {
  xp += amount;
  const xpMax = level * 100;
  if (xp >= xpMax) {
    xp -= xpMax;
    level++;
    gainTitle(level);
  }

  localStorage.setItem("xp", xp);
  localStorage.setItem("level", level);

  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);

  await updateXPInDB(xp, level);
};

</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
 src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

            </body> 
        </html>
