<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tangentia - Mythomathic</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="tangentia.css">
</head>
<body>
<header>
  <button class="back-button" onclick="goTo('map.html')">‚¨Ö Mapa</button>
  <div class="title-center">
    <img src="T_Title.png" alt="Tangentia" class="title-img">
  </div>
  <div class="header-buttons">
    <button onclick="openLore()">üìú Lore</button>
    <button onclick="toggleMenu()">‚ò∞ Men√∫</button>
  </div>
  <nav id="menu">
    <ul>
      <li onclick="goTo('map.html')">Mapa</li>
      <li onclick="goTo('perfil.html')">Perfil</li>
      <li onclick="goTo('config.html')">Configuraci√≥</li>
      <li onclick="goTo('sobremi.html')">Sobre mi</li>
      <li onclick="goTo('contacte.html')">Contacte</li>
    </ul>
  </nav>
</header>

<main class="dimension-container">
  <aside class="categories">
    <button onclick="showSymbols('angles')">Angles i Raons</button>
    <button onclick="showSymbols('triangles')">Triangles</button>
    <button onclick="showSymbols('problemes')">Problemes</button>
  </aside>

  <div class="symbols">
    <!-- Angles i Raons -->
    <img src="icon-tan.png" alt="Angles" class="symbol" data-cat="angles"
         style="top:220px; left:350px;" onclick="openPopup('Expressi√≥ en radians')">
    <img src="icon-tan.png" alt="Angles" class="symbol" data-cat="angles"
         style="top:400px; left:600px;" onclick="openPopup('Expressi√≥ en graus')">
    <img src="icon-tan.png" alt="Angles" class="symbol" data-cat="angles"
         style="top:490px; left:500px;" onclick="openPopup('Raons trigonom√®triques inverses')">
    <img src="icon-tan.png" alt="Angles" class="symbol" data-cat="angles"
         style="top:500px; left:860px;" onclick="openPopup('Identitats de suma i difer√®ncia')">
    <img src="icon-tan.png" alt="Angles" class="symbol" data-cat="angles"
         style="top:550px; left:200px;" onclick="openPopup('Dobles')">
    <img src="icon-tan.png" alt="Angles" class="symbol" data-cat="angles"
         style="top:630px; left:970px;" onclick="openPopup('Cos d\'angle amb condicions')">
    <img src="icon-tan.png" alt="Angles" class="symbol" data-cat="angles"
         style="top:600px; left:340px;" onclick="openPopup('Exercici combinat')">

    <!-- Triangles -->
    <img src="icon-tan.png" alt="Triangles" class="symbol" data-cat="triangles"
         style="top:490px; left:780px;" onclick="openPopup('Resoluci√≥ de triangles')">
    <img src="icon-tan.png" alt="Triangles" class="symbol" data-cat="triangles"
         style="top:400px; left:630px;" onclick="openPopup('Rombe i trapezi')">

    <!-- Problemes aplicats -->
    <img src="icon-tan.png" alt="Problemes" class="symbol" data-cat="problemes"
         style="top:620px; left:1000px;" onclick="openPopup('Capsa m√†gica')">
    <img src="icon-tan.png" alt="Problemes" class="symbol" data-cat="problemes"
         style="top:480px; left:500px;" onclick="openPopup('Columna de pedra')">
    <img src="icon-tan.png" alt="Problemes" class="symbol" data-cat="problemes"
         style="top:490px; left:900px;" onclick="openPopup('Doble observaci√≥ I')">
    <img src="icon-tan.png" alt="Problemes" class="symbol" data-cat="problemes"
         style="top:490px; left:1000px;" onclick="openPopup('Doble observaci√≥ II')">
    <img src="icon-tan.png" alt="Problemes" class="symbol" data-cat="problemes"
         style="top:750px; left:880px;" onclick="openPopup('Dist√†ncia entre fanals')">
  </div>
</main>

<!-- Lore Popup -->
<div id="lorePopup" class="popup">
  <div class="popup-content lore-content">
    <span class="close" onclick="closeLore()">&times;</span>
    <img src="pergami.png" alt="Pergam√≠" class="scroll-img">
  </div>
</div>

<!-- Exercise Popup -->
<div id="exercisePopup" class="popup">
  <div class="popup-content">
    <span class="close" onclick="closePopup()">&times;</span>
    <h2 id="exerciseTitle"></h2>
    <div id="exerciseContent"></div>
    <p id="feedback"></p>
  </div>
</div>

<!-- BOT√ì XAT -->
<div id="capy-toggle">
  <img src="capy.png" alt="Capy">
</div>

<!-- CHATBOT -->
<div id="capy-chat" class="hidden">
  <div class="capy-header">
    <img src="capy.png" alt="Capy">
    <span>Capy - Guia</span>
  </div>
  <div id="capy-messages">
    <div id="capy-thinking" class="hidden">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>
  </div>
  <input id="capy-input" placeholder="Pregunta a Capy...">
</div>

<script>
function toggleMenu(){document.getElementById('menu').classList.toggle('active');}
function goTo(page){window.location.href=page;}
function openLore(){document.getElementById("lorePopup").style.display="flex";}
function closeLore(){document.getElementById("lorePopup").style.display="none";}

function showSymbols(type){
  document.querySelectorAll(".symbol").forEach(el=>el.style.display="none");
  document.querySelectorAll(".symbol[data-cat='"+type+"']").forEach(el=>el.style.display="block");
}
document.addEventListener("DOMContentLoaded",()=>{showSymbols("angles");});

function closePopup(){document.getElementById("exercisePopup").style.display="none";}

// Random util
function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

/* ---------- CHATBOT ---------- */
const capyToggle = document.getElementById("capy-toggle");
const capyChat = document.getElementById("capy-chat");
const capyInput = document.getElementById("capy-input");
const capyMessages = document.getElementById("capy-messages");

capyToggle.onclick = () => capyChat.classList.toggle("hidden");

capyInput.addEventListener("keypress", async (e) => {
  if (e.key === "Enter" && capyInput.value.trim()) {
    const msg = capyInput.value.trim();
    capyMessages.innerHTML += `<p><b>Tu:</b> ${msg}</p>`;
    capyInput.value = "";

    // MOSTREM punts de pensament
    const thinking = document.getElementById("capy-thinking");
    thinking.classList.remove("hidden");

    // Enviem el missatge al servidor
    try {
      const res = await fetch('https://mythomathic-server.onrender.com/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg }),
      });

      const data = await res.json();

      // OCULTEM punts quan arriba la resposta
      thinking.classList.add("hidden");

      // Afegim missatge de Capy amb s√≠mbols matem√†tics
      capyMessages.innerHTML += `<p><b>Capy:</b> ${data.reply}</p>`;
      MathJax.typesetPromise();
      capyMessages.scrollTop = capyMessages.scrollHeight;

    } catch (err) {
      thinking.classList.add("hidden"); // assegurem amagar punts si hi ha error
      capyMessages.innerHTML += `<p><b>Capy:</b> Ups! Hi ha hagut un error al enviar el missatge.</p>`;
      capyMessages.scrollTop = capyMessages.scrollHeight;
    }
  }
});


// Exercicis
const exercises = {
  // === ANGLES I RAONS ===
  "Expressi√≥ en radians":()=>{
    const graus = randomInt(30,330);
    const correct = (graus*Math.PI/180).toFixed(2);
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`<p>Converteix ${graus}¬∞ a radians (2 decimals):</p>
      <input type="text" id="answer" placeholder="Ex: 1.57">
      <button onclick="checkAnswer(${correct})">Comprovar</button>
      <button onclick="exercises['Expressi√≥ en radians']()">Nova activitat</button>`;
  },
  "Expressi√≥ en graus":()=>{
    const rad = (randomInt(1,10)*Math.PI/6).toFixed(2);
    const graus = (rad*180/Math.PI).toFixed(2);
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`<p>Converteix ${rad} rad a graus (2 decimals):</p>
      <input type="text" id="answer" placeholder="Ex: 30">
      <button onclick="checkAnswer(${graus})">Comprovar</button>
      <button onclick="exercises['Expressi√≥ en graus']()">Nova activitat</button>`;
  },

"Raons trigonom√®triques inverses":()=>{
  const options=[
    {f:"arcsin",val:(Math.random()*0.9+0.1).toFixed(2)},
    {f:"arccos",val:(Math.random()*0.9).toFixed(2)},
    {f:"arctan",val:(Math.random()*3+0.5).toFixed(2)}
  ];
  const choice=options[randomInt(0,options.length-1)];
  let angle;
  if(choice.f==="arcsin") angle=(Math.asin(choice.val)*180/Math.PI).toFixed(2);
  if(choice.f==="arccos") angle=(Math.acos(choice.val)*180/Math.PI).toFixed(2);
  if(choice.f==="arctan") angle=(Math.atan(choice.val)*180/Math.PI).toFixed(2);
  const container=document.getElementById("exerciseContent");
  container.innerHTML=`
    <p>Calcula l‚Äôangle (en graus) que compleix <b>${choice.f}(${choice.val})</b>.</p>
    <input type="text" id="answer" placeholder="Ex: 32.11">
    <button onclick="checkAnswer(${angle})">Comprovar</button>
    <button onclick="exercises['Raons trigonom√®triques inverses']()">Nova activitat</button>`;
},

"Identitats de suma i difer√®ncia":()=>{
  const a=[15,30,45,60,75,105][randomInt(0,5)];
  const b=[15,30,45,60,75,105][randomInt(0,5)];
  const forms=[
    {txt:`sin(${a}+${b})`, val:Math.sin((a+b)*Math.PI/180).toFixed(2)},
    {txt:`sin(${a}-${b})`, val:Math.sin((a-b)*Math.PI/180).toFixed(2)},
    {txt:`cos(${a}+${b})`, val:Math.cos((a+b)*Math.PI/180).toFixed(2)},
    {txt:`cos(${a}-${b})`, val:Math.cos((a-b)*Math.PI/180).toFixed(2)}
  ];
  const chosen=forms[randomInt(0,forms.length-1)];
  const container=document.getElementById("exerciseContent");
  container.innerHTML=`
    <p>Aplica les identitats trigonom√®triques per calcular:  
    <b>${chosen.txt}</b> (arrodoneix a 2 decimals).</p>
    <input type="text" id="answer" placeholder="Ex: 0.71">
    <button onclick="checkAnswer(${chosen.val})">Comprovar</button>
    <button onclick="exercises['Identitats de suma i difer√®ncia']()">Nova activitat</button>`;
},

"Dobles":()=>{
  const a=[15,30,45,60,75,90][randomInt(0,5)];
  const forms=[
    {txt:`sin(2¬∑${a}¬∞)`, val:Math.sin(2*a*Math.PI/180).toFixed(2)},
    {txt:`cos(2¬∑${a}¬∞)`, val:Math.cos(2*a*Math.PI/180).toFixed(2)},
    {txt:`tan(2¬∑${a}¬∞)`, val:Math.tan(2*a*Math.PI/180).toFixed(2)}
  ];
  const chosen=forms[randomInt(0,forms.length-1)];
  const container=document.getElementById("exerciseContent");
  container.innerHTML=`
    <p>Aplica les f√≥rmules de doble angle per calcular:  
    <b>${chosen.txt}</b> (arrodoneix a 2 decimals).</p>
    <input type="text" id="answer" placeholder="Ex: 0.87">
    <button onclick="checkAnswer(${chosen.val})">Comprovar</button>
    <button onclick="exercises['Dobles']()">Nova activitat</button>`;
},

"Cos d'angle amb condicions":()=>{
    const candidates=[
      ["-‚àö3", Math.tan(120*Math.PI/180)],
      ["-‚àö5", -Math.sqrt(5)],
      ["1", 1],
      ["-1", -1],
      ["‚àö3", Math.sqrt(3)]
    ];
    const chosen=candidates[randomInt(0,candidates.length-1)];
    const intervals=[
      {txt:"œÄ/2 ‚â§ 2Œ± ‚â§ œÄ", quad:"I"},
      {txt:"œÄ ‚â§ 2Œ± ‚â§ 3œÄ/2", quad:"II"},
      {txt:"0 ‚â§ 2Œ± ‚â§ œÄ/2", quad:"I"},
      {txt:"3œÄ/2 ‚â§ 2Œ± ‚â§ 2œÄ", quad:"IV"}
    ];
    const chosenInt=intervals[randomInt(0,intervals.length-1)];

    const container=document.getElementById("exerciseContent");
    container.innerHTML=`
      <p>Sapiguem que <b>tan(2Œ±) = ${chosen[0]}</b> i <b>${chosenInt.txt}</b>.<br>
      Calcula <b>cosŒ±</b>. En quin quadrant es troba Œ±?</p>
      <input type="text" id="answer" placeholder="Escriu cosŒ± (aprox)">
      <select id="quadrant">
        <option value="">-- Tria quadrant --</option>
        <option value="I">Quadrant I</option>
        <option value="II">Quadrant II</option>
        <option value="III">Quadrant III</option>
        <option value="IV">Quadrant IV</option>
      </select>
      <button onclick="checkCosAlpha(${chosen[1]}, '${chosenInt.quad}')">Comprovar</button>
      <button onclick="exercises['Cos d\\'angle amb condicions']()">Nova activitat</button>
    `;
  },

  "Exercici combinat":()=>{
    const n=[3,4,5,6,7,8][randomInt(0,5)];
    const k=randomInt(1,n-1);
    const sinA=k/n;
    const cosA=-Math.sqrt(1-sinA**2);

    const q=[3,4,5,6,7,8,9,10][randomInt(0,7)];
    const p=randomInt(1,q-1);
    const cosB=p/q;
    const sinB=Math.sqrt(1-cosB**2);

    const container=document.getElementById("exerciseContent");
    container.innerHTML=`
      <p>Si <b>sinŒ± = ${k}/${n}</b> amb <b>œÄ/2 ‚â§ Œ± ‚â§ œÄ</b><br>
      i <b>cosŒ≤ = ${p}/${q}</b> amb <b>Œ≤ ‚â§ 90¬∞</b>, calcula:</p>
      <ol>
        <li>a) sin(2Œ±)</li>
        <li>b) cos(2Œ±)</li>
        <li>c) sin(2Œ≤)</li>
        <li>d) cos(2Œ≤)</li>
        <li>e) sin(Œ±/2)</li>
        <li>f) cos(Œ≤/2)</li>
        <li>g) sin(Œ±+2Œ≤)</li>
        <li>h) cos(2Œ±-Œ≤)</li>
        <li>i) cos(Œ±+2Œ≤)</li>
        <li>j) sin(2Œ±-Œ≤)</li>
      </ol>
      <textarea id="answer" placeholder="Escriu respostes separades per comes"></textarea>
      <button onclick="checkExerciciCombinat(${sinA},${cosA},${sinB},${cosB})">Comprovar</button>
      <button onclick="exercises['Exercici combinat']()">Nova activitat</button>
    `;
  },


// === TRIANGLES ===
"Resoluci√≥ de triangles":()=>{
  const a=randomInt(20,80), b=randomInt(20,80);
  const angC=randomInt(30,100); // Llei dels cosinus
  const c=Math.sqrt(a*a+b*b-2*a*b*Math.cos(angC*Math.PI/180)).toFixed(2);
  const container=document.getElementById("exerciseContent");
  container.innerHTML=`
    <p>Es considera un triangle amb costats <b>a=${a} cm</b> i <b>b=${b} cm</b>, 
    i angle compr√®s entre ells de <b>${angC}¬∞</b>.  
    Calcula la longitud del tercer costat <b>c</b> (arrodoneix a 2 decimals).</p>
    <input type="text" id="answer" placeholder="Ex: 23.45">
    <button onclick="checkAnswer(${c})">Comprovar</button>
    <button onclick="exercises['Resoluci√≥ de triangles']()">Nova activitat</button>`;
},

"Rombe i trapezi":()=>{
  const diag1=randomInt(10,40), diag2=randomInt(10,40);
  const rombeCostat=(Math.sqrt((diag1/2)**2+(diag2/2)**2)).toFixed(2);
  const base1=randomInt(10,30), base2=randomInt(5,25), altura=randomInt(8,20);
  const trapeziArea=(((base1+base2)/2)*altura).toFixed(2);

  const container=document.getElementById("exerciseContent");
  container.innerHTML=`
    <p><b>Part 1 (Rombe):</b> Un rombe t√© diagonals de <b>${diag1} cm</b> i <b>${diag2} cm</b>.  
    Calcula la longitud del seu costat (arrodonit a 2 decimals).</p>
    <input type="text" id="answerRombe" placeholder="Ex: 12.34"><br><br>

    <p><b>Part 2 (Trapezi):</b> Un trapezi t√© bases de <b>${base1} cm</b> i <b>${base2} cm</b>, i altura <b>${altura} cm</b>.  
    Calcula la seva √†rea (arrodonida a 2 decimals).</p>
    <input type="text" id="answerTrap" placeholder="Ex: 245.00"><br>

    <button onclick="checkRombeTrapezi(${rombeCostat},${trapeziArea})">Comprovar</button>
    <button onclick="exercises['Rombe i trapezi']()">Nova activitat</button>`;
},


  // === PROBLEMES ===
"Capsa m√†gica":()=>{
  const a=randomInt(2,10), b=randomInt(3,12), c=randomInt(5,20);
  const d=Math.sqrt(a*a+b*b+c*c).toFixed(2);
  const container=document.getElementById("exerciseContent");
  container.innerHTML=`
    <p>Una capsa t√© unes dimensions de <b>${a} m</b> d‚Äôamplada, 
    <b>${b} m</b> de profunditat i <b>${c} m</b> d‚Äôal√ßada.  
    Calcula la longitud de la diagonal de l‚Äôespai interior de la capsa (arrodoneix a 2 decimals).</p>
    <input type="text" id="answer" placeholder="Ex: 14.32">
    <button onclick="checkAnswer(${d})">Comprovar</button>
    <button onclick="exercises['Capsa m√†gica']()">Nova activitat</button>`;
},

"Columna de pedra":()=>{
  const h=randomInt(5,30), ombra=randomInt(3,25);
  const ang=(Math.atan(h/ombra)*180/Math.PI).toFixed(2);
  const container=document.getElementById("exerciseContent");
  container.innerHTML=`
    <p>Una columna de pedra de <b>${h} m</b> d‚Äôal√ßada projecta una ombra de <b>${ombra} m</b>.  
    Calcula l‚Äôangle d‚Äôelevaci√≥ del Sol respecte al terra (en graus, amb 2 decimals).</p>
    <input type="text" id="answer" placeholder="Ex: 63.43">
    <button onclick="checkAnswer(${ang})">Comprovar</button>
    <button onclick="exercises['Columna de pedra']()">Nova activitat</button>`;
},

"Doble observaci√≥ I":()=>{
  const d=randomInt(50,200), h=randomInt(20,100);
  const ang=(Math.atan(h/d)*180/Math.PI).toFixed(2);
  const container=document.getElementById("exerciseContent");
  container.innerHTML=`
    <p>Un observador es troba a <b>${d} m</b> de la base d‚Äôun edifici que t√© una al√ßada de <b>${h} m</b>.  
    Calcula l‚Äôangle d‚Äôelevaci√≥ des del punt de l‚Äôobservador fins a la part superior de l‚Äôedifici.</p>
    <input type="text" id="answer" placeholder="Ex: 26.57">
    <button onclick="checkAnswer(${ang})">Comprovar</button>
    <button onclick="exercises['Doble observaci√≥ I']()">Nova activitat</button>`;
},

"Doble observaci√≥ II":()=>{
  const d1=randomInt(30,80), d2=d1+randomInt(20,60), h=randomInt(15,50);
  const ang1=(Math.atan(h/d1)*180/Math.PI).toFixed(2);
  const ang2=(Math.atan(h/d2)*180/Math.PI).toFixed(2);
  const container=document.getElementById("exerciseContent");
  container.innerHTML=`
    <p>Des d‚Äôun primer punt situat a <b>${d1} m</b> de la base d‚Äôuna torre d‚Äôal√ßada <b>${h} m</b> 
    es mesura un angle d‚Äôelevaci√≥.  
    Despla√ßant-se fins a un altre punt a <b>${d2} m</b> de la torre es mesura un altre angle.  
    Calcula aquests dos angles d‚Äôelevaci√≥ (arrodonits a 2 decimals).</p>
    <p><i>Pots introduir les dues respostes separades per comes, ex: 58.23, 45.11</i></p>
    <input type="text" id="answer" placeholder="Ex: 58.23, 45.11">
    <button onclick="checkDoubleAnswer(${ang1},${ang2})">Comprovar</button>
    <button onclick="exercises['Doble observaci√≥ II']()">Nova activitat</button>`;
},

"Dist√†ncia entre fanals":()=>{
  const h=randomInt(5,15), ang=randomInt(15,60);
  const dist=(h/Math.tan(ang*Math.PI/180)).toFixed(2);
  const container=document.getElementById("exerciseContent");
  container.innerHTML=`
    <p>Un fanal t√© una al√ßada de <b>${h} m</b>.  
    Des d‚Äôun punt d‚Äôobservaci√≥, l‚Äôangle d‚Äôelevaci√≥ fins a la part superior del fanal √©s de <b>${ang}¬∞</b>.  
    Calcula la dist√†ncia horitzontal entre l‚Äôobservador i el peu del fanal.</p>
    <input type="text" id="answer" placeholder="Ex: 13.86">
    <button onclick="checkAnswer(${dist})">Comprovar</button>
    <button onclick="exercises['Dist√†ncia entre fanals']()">Nova activitat</button>`;
}};


function openPopup(title){
  document.getElementById("exerciseTitle").textContent=title;
  document.getElementById("exercisePopup").style.display="flex";
  if(exercises[title]){exercises[title]();}
  else{document.getElementById("exerciseContent").innerHTML="<p>Encara no hi ha exercicis disponibles.</p>";}
  document.getElementById("feedback").textContent="";
}

function checkDoubleAnswer(correct1, correct2){
  const user=document.getElementById("answer").value.trim().split(",");
  const fb=document.getElementById("feedback");
  if(user.length!==2){fb.innerHTML="‚ùå Introdueix dues respostes separades per coma."; return;}
  const u1=parseFloat(user[0]), u2=parseFloat(user[1]);
  if(Math.abs(u1-correct1)<0.1 && Math.abs(u2-correct2)<0.1){
    fb.innerHTML="‚úÖ <span style='color:lightgreen'>Correcte!</span>";
    onExerciseCorrect();
  } else {
    fb.innerHTML=`‚ùå Incorrecte (esperat: ${correct1}, ${correct2})`;
  }
}

function checkCosAlpha(val, quadCorrect){
  const fb=document.getElementById("feedback");
  const quad=document.getElementById("quadrant").value;
  const userAns=parseFloat(document.getElementById("answer").value.trim());
  if(quad===quadCorrect && !isNaN(userAns)){
    fb.textContent="‚úÖ Correcte! (cosŒ± i quadrant correctes)";
    fb.style.color="green";
    onExerciseCorrect();
  } else {
    fb.textContent="‚ùå Incorrecte. Revisa el signe del cos i el quadrant.";
    fb.style.color="red";
  }
}

function checkExerciciCombinat(sinA, cosA, sinB, cosB){
  const fb = document.getElementById("feedback");
  const user = document.getElementById("answer").value.trim().split(",");
  if(user.length !== 10){
    fb.textContent = "‚ùå Introdueix 10 respostes separades per comes.";
    fb.style.color = "red";
    return;
  }

  const expected = [
    (2*sinA*cosA).toFixed(3),
    (cosA**2-sinA**2).toFixed(3),
    (2*sinB*cosB).toFixed(3),
    (cosB**2-sinB**2).toFixed(3),
    Math.sqrt((1-cosA)/2).toFixed(3),
    Math.sqrt((1+cosB)/2).toFixed(3),
    (sinA*Math.cos(2*Math.acos(cosB))+cosA*Math.sin(2*Math.acos(cosB))).toFixed(3),
    Math.cos(2*Math.asin(sinA)-Math.acos(cosB)).toFixed(3),
    Math.cos(Math.asin(sinA)+2*Math.acos(cosB)).toFixed(3),
    Math.sin(2*Math.asin(sinA)-Math.acos(cosB)).toFixed(3)
  ];

  let correct = true;
  for(let i=0; i<10; i++){
    if(parseFloat(user[i]).toFixed(3) !== expected[i]){
      correct = false;
      break;
    }
  }

  if(correct){
    fb.innerHTML = "‚úÖ Correcte! Totes les respostes s√≥n correctes.";
    fb.style.color = "green";
    onExerciseCorrect(); // <-- Cridem la funci√≥ d'experi√®ncia nom√©s quan √©s correcte
  } else {
    fb.innerHTML = `‚ùå Alguna resposta √©s incorrecta.<br>Respostes correctes: ${expected.join(", ")}`;
    fb.style.color = "red";
  }
}



function checkRombeTrapezi(correctRombe, correctTrap){
  const fb=document.getElementById("feedback");
  const userRombe=parseFloat(document.getElementById("answerRombe").value.trim());
  const userTrap=parseFloat(document.getElementById("answerTrap").value.trim());

  if(Math.abs(userRombe-correctRombe)<0.1 && Math.abs(userTrap-correctTrap)<0.1){
    fb.innerHTML="‚úÖ <span style='color:lightgreen'>Correcte! Tant el rombe com el trapezi s√≥n correctes.</span>";
    onExerciseCorrect();
  } else {
    fb.innerHTML=`‚ùå <span style='color:red'>Incorrecte. Les respostes correctes eren costat del rombe = ${correctRombe}, √†rea del trapezi = ${correctTrap}</span>`;
  }
}

function checkAnswer(correct){
  const user=document.getElementById("answer").value.trim();
  const fb=document.getElementById("feedback");
  if(parseFloat(user).toFixed(2)==parseFloat(correct).toFixed(2)){
    fb.innerHTML="‚úÖ <span style='color:lightgreen'>Correcte!</span>";
    onExerciseCorrect();
  } else {
    fb.innerHTML=`‚ùå <span style='color:red'>Incorrecte (esperat: ${correct})</span>`;
  }
}


// ================== EXPERI√àNCIA =====================
let correctExercises=0;
let xp=parseInt(localStorage.getItem("xp"))||0;
let level=parseInt(localStorage.getItem("level"))||1;
let xpGainBase=50;

function addXP(amount){
  xp+=amount;
  const xpMax=level*100;
  if(xp>=xpMax){ xp-=xpMax; level++; gainTitle(level); }
  localStorage.setItem("xp",xp);
  localStorage.setItem("level",level);
  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);
}
function gainTitle(level){
  const titles={
    1:"Custodi del Flux",2:"Guardi√† del Patr√≥",3:"Savi d‚ÄôEkuatia",
    4:"Somniador de Tangentia",5:"Vigilant de Complexia",
    6:"Cercador de Functonia",7:"Mestre de Derivalia"
  };
  const newTitle=titles[level]||`Aventurer Nivell ${level}`;
  alert(`‚ú® Has pujat de nivell! Nou t√≠tol: ${newTitle}`);
  localStorage.setItem("title",newTitle);
}
function onExerciseCorrect(){
  correctExercises++;
  if(correctExercises%5===0){
    const earnedXP=Math.max(10,xpGainBase-(level-1)*5);
    addXP(earnedXP);
  }
}


function openPopup(title){
  const popup = document.getElementById("exercisePopup");
  document.getElementById("exerciseTitle").textContent = title;
  popup.style.display = "flex";
  document.getElementById("feedback").textContent = "";

  // Si l'exercici existeix, l'executem
  if(exercises[title]){
    exercises[title]();

    // Nom√©s per a "Exercici combinat"
    if(title === "Exercici combinat"){
      // Afegim listener per fer clic fora del popup-content
      const clickOutside = (event) => {
        if(!popup.querySelector(".popup-content").contains(event.target)){
          popup.style.display = "none";
          document.removeEventListener("click", clickOutside);
        }
      };
      // Utilitzem setTimeout per evitar que el click d'obertura tanqui directament
      setTimeout(() => document.addEventListener("click", clickOutside), 0);
    }
  } else {
    document.getElementById("exerciseContent").innerHTML = "<p>Encara no hi ha exercicis disponibles.</p>";
  }
}





</script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// üîπ Configuraci√≥ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDPVUQZXaSAARwROsDgvlohMvB-esYvMrA",
  authDomain: "mythomathic.firebaseapp.com",
  projectId: "mythomathic",
  storageBucket: "mythomathic.firebasestorage.app",
  messagingSenderId: "396574593247",
  appId: "1:396574593247:web:5b7f02c53de5613eda996a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

// üîπ Quan l‚Äôusuari est√† autenticat, recuperem el seu XP actual
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    const ref = doc(db, "users", user.uid);
    const snapshot = await getDoc(ref);
    if (snapshot.exists()) {
      const data = snapshot.data();
      xp = data.xp || 0;
      level = data.level || 1;
      localStorage.setItem("xp", xp);
      localStorage.setItem("level", level);
    }
  } else {
    console.warn("Usuari no autenticat ‚Äî XP nom√©s local.");
  }
});

// üîπ Funci√≥ per sincronitzar XP amb la base de dades
async function updateXPInDB(newXP, newLevel) {
  if (!currentUser) return;
  try {
    await updateDoc(doc(db, "users", currentUser.uid), {
      xp: newXP,
      level: newLevel
    });
    console.log("‚úÖ XP actualitzat al n√∫vol:", newXP, "nivell:", newLevel);
  } catch (err) {
    console.error("‚ùå Error actualitzant XP a Firestore:", err);
  }
}

// ‚ú® Modifica la funci√≥ addXP perqu√® actualitzi Firebase tamb√©
window.addXP = async function(amount) {
  xp += amount;
  const xpMax = level * 100;
  if (xp >= xpMax) {
    xp -= xpMax;
    level++;
    gainTitle(level);
  }

  localStorage.setItem("xp", xp);
  localStorage.setItem("level", level);

  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);

  await updateXPInDB(xp, level);
};

</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
 src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

</body>
</html>




