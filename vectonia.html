<!DOCTYPE html> 
<html lang="ca"> 
    <head> 
        <meta charset="UTF-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <title>Vectonia - Mythomathic</title> 
        <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"> 
        <link rel="stylesheet" href="vectonia.css"> 
    </head> 
<body> 
    <header> 
<button class="back-button" onclick="goTo('map.html')">‚¨Ö Mapa</button> 
<div class="title-center"> 
<img src="V_Title.png" alt="Vectonia" class="title-img"> 
</div> 
<div class="header-buttons"> 
    <button onclick="openLore()">üìú Lore</button> 
    <button onclick="toggleMenu()">‚ò∞ Men√∫</button> 
</div> 
<nav id="menu"> 
    <ul> <li onclick="goTo('map.html')">Mapa</li> 
        <li onclick="goTo('perfil.html')">Perfil</li> 
        <li onclick="goTo('config.html')">Configuraci√≥</li> 
        <li onclick="goTo('sobremi.html')">Sobre mi</li> 
        <li onclick="goTo('contacte.html')">Contacte</li> 
    </ul> 
</nav> 
</header> 

<main class="dimension-container">
  <aside class="categories">
    <button onclick="showSymbols('vectors')">Operacions amb vectors</button>
    <button onclick="showSymbols('punts')">Punts i rectes</button>
    <button onclick="showSymbols('angles')">Angles i posici√≥</button>
    <button onclick="showSymbols('figures')">Figures i dist√†ncies</button>
  </aside>

  <div class="symbols">
    <!-- VECTORS -->
    <img src="icon-vec.png" class="symbol" data-cat="vectors" style="top:200px; left:400px;" onclick="openPopup('Operacions vectorials')">
    <img src="icon-vec.png" class="symbol" data-cat="vectors" style="top:400px; left:800px;" onclick="openPopup('Producte escalar i m√≤dul')">
    <img src="icon-vec.png" class="symbol" data-cat="vectors" style="top:600px; left:300px;" onclick="openPopup('Vector unitari i perpendicular')">

    <!-- PUNTS I RECTES -->
    <img src="icon-vec.png" class="symbol" data-cat="punts" style="top:200px; left:700px;" onclick="openPopup('Coordenades de punts')">
    <img src="icon-vec.png" class="symbol" data-cat="punts" style="top:400px; left:500px;" onclick="openPopup('Equacions de rectes')">

    <!-- ANGLES I POSICI√ì -->
    <img src="icon-vec.png" class="symbol" data-cat="angles" style="top:250px; left:900px;" onclick="openPopup('Paral¬∑lelisme i perpendicularitat')">
    <img src="icon-vec.png" class="symbol" data-cat="angles" style="top:450px; left:350px;" onclick="openPopup('Interseccions i punts de tall')">
    <img src="icon-vec.png" class="symbol" data-cat="angles" style="top:350px; left:700px;" onclick="openPopup('Angles entre rectes')">
    <img src="icon-vec.png" class="symbol" data-cat="angles" style="top:250px; left:400px;" onclick="openPopup('Rectes secants')">

    <!-- FIGURES -->
    <img src="icon-vec.png" class="symbol" data-cat="figures" style="top:200px; left:300px;" onclick="openPopup('Triangles')">
    <img src="icon-vec.png" class="symbol" data-cat="figures" style="top:500px; left:900px;" onclick="openPopup('Dist√†ncies i punts a rectes')">
    <img src="icon-vec.png" class="symbol" data-cat="figures" style="top:500px; left:900px;" onclick="openPopup('Paral¬∑lelogram')">
  </div>
</main>

<!-- POPUP LORE --> 
<div id="lorePopup" class="popup"> 
  <div class="popup-content lore-content"> 
    <span class="close" onclick="closeLore()">&times;</span>
    <img src="lore_R.png" alt="Pergam√≠" class="scroll-img"> 
  </div> 
</div> 

<!-- POPUP -->
<div id="exercisePopup" class="popup">
  <div class="popup-content">
    <span class="close" onclick="closePopup()">&times;</span>
    <h2 id="exerciseTitle"></h2>
    <div id="exerciseContent"></div>
    <p id="feedback"></p>
  </div>
</div>

<!-- CHATBOT -->
<div id="capy-toggle">
  <img src="capy2.png" alt="Capy">
</div>

<div id="capy-chat" class="hidden">
  <div class="capy-header">
    <img src="capy2.png" alt="Capy">
    <span>Capy - Guia</span>
  </div>
  <div id="capy-messages"></div>
  <input id="capy-input" placeholder="Pregunta a Capy...">
  <div id="capy-thinking" class="hidden">
  <span class="dot"></span>
  <span class="dot"></span>
  <span class="dot"></span>
</div>
</div>

<script>

function toggleMenu() { 
  document.getElementById('menu').classList.toggle('active'); 
} 

function goTo(page) { 
  window.location.href = page; 
} 

function openLore() { 
  document.getElementById("lorePopup").style.display = "flex"; 
} 



// funci√≥ existent: tanca el popup lore
  function closeLore(){
    const lp = document.getElementById("lorePopup");
    if(lp) lp.style.display = "none";
  }

  // fallback: assegurem l'event si l'atribut onclick no s'executa per algun motiu
  document.addEventListener("DOMContentLoaded", () => {
    const closeBtn = document.querySelector(".lore-content .close");
    if(closeBtn){
      closeBtn.addEventListener("click", closeLore);
    }
    // Tamb√© fem que fer click a la capa fosca tanqui el popup (opcional)
    const lorePopup = document.getElementById("lorePopup");
    if(lorePopup){
      lorePopup.addEventListener("click", (e) => {
        if(e.target === lorePopup) closeLore(); // nom√©s si cliques fora del contingut
      });
    }
  });


function showSymbols(cat){
  document.querySelectorAll('.symbol').forEach(s=>s.style.display='none');
  document.querySelectorAll(`.symbol[data-cat="${cat}"]`).forEach(s=>s.style.display='block');
}
document.addEventListener('DOMContentLoaded',()=>showSymbols('vectors'));
function closePopup(){document.getElementById('exercisePopup').style.display='none';}
function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function randomChoice(a){return a[Math.floor(Math.random()*a.length)];}

function checkTextAnswers(expected){
  const user=document.getElementById("answer1").value.trim().toLowerCase().replace(/\s+/g,'');
  const valid=expected.map(e=>e.toLowerCase().replace(/\s+/g,''));
  const fb=document.getElementById("feedback");

  if(valid.includes(user)){
    fb.innerHTML = "‚úÖ Correcte!";
    onExerciseCorrect();
  } else {
    fb.innerHTML = `‚ùå Incorrecte (resposta esperada: ${expected[0]})`;
  }
}

/* ---------- CHATBOT ---------- */
const capyToggle = document.getElementById("capy-toggle");
const capyChat = document.getElementById("capy-chat");
const capyInput = document.getElementById("capy-input");
const capyMessages = document.getElementById("capy-messages");

capyToggle.onclick = () => capyChat.classList.toggle("hidden");

capyInput.addEventListener("keypress", async (e) => {
  if (e.key === "Enter" && capyInput.value.trim()) {
    const msg = capyInput.value.trim();
    capyMessages.innerHTML += `<p><b>Tu:</b> ${msg}</p>`;
    capyInput.value = "";

    // MOSTREM punts de pensament
    const thinking = document.getElementById("capy-thinking");
    thinking.classList.remove("hidden");

    // Enviem el missatge al servidor
    try {
      const res = await fetch('https://mythomathic-server.onrender.com/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg }),
      });

      const data = await res.json();

      // OCULTEM punts quan arriba la resposta
      thinking.classList.add("hidden");

      // Afegim missatge de Capy amb s√≠mbols matem√†tics
      capyMessages.innerHTML += `<p><b>Capy:</b> ${data.reply}</p>`;
      MathJax.typesetPromise();
      capyMessages.scrollTop = capyMessages.scrollHeight;

    } catch (err) {
      thinking.classList.add("hidden"); // assegurem amagar punts si hi ha error
      capyMessages.innerHTML += `<p><b>Capy:</b> Ups! Hi ha hagut un error al enviar el missatge.</p>`;
      capyMessages.scrollTop = capyMessages.scrollHeight;
    }
  }
});

// ====== EXERCICIS ======
const exercises={

  // 1Ô∏è‚É£ OPERACIONS VECTORIALS
  "Operacions vectorials":()=>{
    const u1=randomInt(-5,5), u2=randomInt(-5,5);
    const v1=randomInt(-5,5), v2=randomInt(-5,5);
    const w1=randomInt(-5,5), w2=randomInt(-5,5);
    const ans=`u+v-w=(${u1+v1-w1},${u2+v2-w2})`;
    document.getElementById("exerciseContent").innerHTML=`
      <p>Donats els vectors ‚Üíu=(${u1},${u2}), ‚Üív=(${v1},${v2}) i ‚Üíw=(${w1},${w2}), calcula:</p>
      <p><b>‚Üíu+‚Üív‚àí‚Üíw</b></p>
      <input id="answer1" placeholder="Ex: (x,y)">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Operacions vectorials']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // 2Ô∏è‚É£ PRODUCTE ESCALAR I M√íDUL
  "Producte escalar i m√≤dul":()=>{
    const u1=randomInt(-5,5), u2=randomInt(-5,5);
    const v1=randomInt(-5,5), v2=randomInt(-5,5);
    const prod=u1*v1+u2*v2;
    const modU=Math.sqrt(u1*u1+u2*u2).toFixed(2);
    document.getElementById("exerciseContent").innerHTML=`
      <p>Calcula el producte escalar i el m√≤dul de ‚Üíu=(${u1},${u2}) i ‚Üív=(${v1},${v2}).</p>
      <input id="answer1" placeholder="Ex: producte=..., m√≤dul=...">
      <button onclick="checkTextAnswers(['producte=${prod},m√≤dul=${modU}'])">Comprovar</button>
      <button onclick="exercises['Producte escalar i m√≤dul']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // 3Ô∏è‚É£ VECTOR UNITARI I PERPENDICULAR
  "Vector unitari i perpendicular":()=>{
    const u1=randomInt(-7,7), u2=randomInt(-7,7);
    const mod=Math.sqrt(u1*u1+u2*u2);
    const unitX=(u1/mod).toFixed(2), unitY=(u2/mod).toFixed(2);
    const perpX=-u2, perpY=u1;
    document.getElementById("exerciseContent").innerHTML=`
      <p>Troba un vector unitari i un perpendicular a ‚Üíu=(${u1},${u2}).</p>
      <input id="answer1" placeholder="Ex: unitari=(x,y), perpendicular=(x,y)">
      <button onclick="checkTextAnswers(['unitari=(${unitX},${unitY}),perpendicular=(${perpX},${perpY})'])">Comprovar</button>
      <button onclick="exercises['Vector unitari i perpendicular']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // 4Ô∏è‚É£ COORDENADES DE PUNTS
  "Coordenades de punts":()=>{
    const ax=randomInt(-5,5), ay=randomInt(-5,5);
    const abx=randomInt(-5,5), aby=randomInt(-5,5);
    const bx=ax+abx, by=ay+aby;
    const ans=`B(${bx},${by})`;
    document.getElementById("exerciseContent").innerHTML=`
      <p>Si ‚ÜíAB=(${abx},${aby}) i A(${ax},${ay}), calcula les coordenades de B.</p>
      <input id="answer1" placeholder="Ex: B(x,y)">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Coordenades de punts']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // 5Ô∏è‚É£ EQUACIONS DE RECTES
  "Equacions de rectes":()=>{
    const a1=randomInt(-3,3), a2=randomInt(-3,3);
    const b1=randomInt(-3,3), b2=randomInt(-3,3);
    const m=((b2-a2)/(b1-a1)).toFixed(2);
    const n=(a2 - m*a1).toFixed(2);
    const ans=`y=${m}x+${n}`;
    document.getElementById("exerciseContent").innerHTML=`
      <p>Calcula l'equaci√≥ de la recta que passa per A(${a1},${a2}) i B(${b1},${b2}).</p>
      <input id="answer1" placeholder="Ex: y=mx+n">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Equacions de rectes']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // 6Ô∏è‚É£ PARAL¬∑LELISME I PERPENDICULARITAT
  "Paral¬∑lelisme i perpendicularitat":()=>{
    const k=randomInt(-4,4);
    const ansPar=(2*k===-4)?'Paral¬∑lels':'No';
    const ansPerp=(2*k+0===0)?'Perpendiculars':'No';
    document.getElementById("exerciseContent").innerHTML=`
      <p>Troba el valor de k perqu√® els vectors ‚Üíu=(${k},-1) i ‚Üív=(-2,4) siguin paral¬∑lels o perpendiculars.</p>
      <input id="answer1" placeholder="Ex: Paral¬∑lels:k=..., Perpendiculars:k=...">
      <button onclick="checkTextAnswers(['Paral¬∑lels:k=-2,Perpendiculars:k=0.5'])">Comprovar</button>
      <button onclick="exercises['Paral¬∑lelisme i perpendicularitat']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // 7Ô∏è‚É£ INTERSECCIONS I PUNTS DE TALL
  "Interseccions i punts de tall":()=>{
    const m1=randomInt(1,5), n1=randomInt(-5,5);
    const m2=randomInt(1,5), n2=randomInt(-5,5);
    const x=(n2-n1)/(m1-m2);
    const y=m1*x+n1;
    const ans=`(${x.toFixed(2)},${y.toFixed(2)})`;
    document.getElementById("exerciseContent").innerHTML=`
      <p>Troba el punt de tall entre r: y=${m1}x+${n1} i s: y=${m2}x+${n2}</p>
      <input id="answer1" placeholder="Ex: (x,y)">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Interseccions i punts de tall']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  },

  // üîπ ANGLES ENTRE RECTES
"Angles entre rectes":()=>{
  const tipus=randomInt(1,3); // Tria quin tipus d‚Äôequaci√≥ es genera
  let textR, textS, m1, m2;

  if(tipus===1){
    // Tipus ax+by+c=0
    const a1=randomInt(1,6), b1=randomInt(-6,-1), c1=randomInt(-5,5);
    const a2=randomInt(1,6), b2=randomInt(1,6), c2=randomInt(-5,5);
    m1=-(a1/b1);
    m2=-(a2/b2);
    textR=`${a1}x${b1<0?'+':''}${b1}y${c1>=0?'+':''}${c1}=0`;
    textS=`${a2}x${b2<0?'+':''}${b2}y${c2>=0?'+':''}${c2}=0`;
  } 
  else if(tipus===2){
    // Tipus y = mx + n
    m1=randomInt(-5,5); const n1=randomInt(-5,5);
    m2=randomInt(-5,5); const n2=randomInt(-5,5);
    textR=`y=${m1}x${n1>=0?'+':''}${n1}`;
    textS=`y=${m2}x${n2>=0?'+':''}${n2}`;
  } 
  else {
    // Tipus fraccions param√®triques
    const n1=randomInt(1,6), d1=randomInt(1,6);
    const n2=randomInt(1,6), d2=randomInt(1,6);
    m1=n1/d1;
    m2=n2/d2;
    textR=`x/${d1}=y/${n1}`;
    textS=`x/${d2}=y/${n2}`;
  }

  // c√†lcul angle
  const angle=(Math.atan(Math.abs((m1-m2)/(1+m1*m2)))*180/Math.PI).toFixed(2);
  const ans=`${angle}¬∞`;

  document.getElementById("exerciseContent").innerHTML=`
    <p>Calcula l'angle que formen aquestes dues rectes:</p>
    <p><b>r:</b> ${textR}</p>
    <p><b>s:</b> ${textS}</p>
    <input id="answer1" placeholder="Ex: Œ±=...¬∞">
    <button onclick="checkTextAnswers(['Œ±=${ans}','${ans}','angle=${ans}'])">Comprovar</button>
    <button onclick="exercises['Angles entre rectes']()">Nova activitat</button>
  `;
  document.getElementById("feedback").innerHTML="";
},

// üîπ RECTES SECANTS
"Rectes secants":()=>{
  const tipus=randomInt(1,3);
  let textR, textS, m1, n1, m2, n2, x, y, secants;

  if(tipus===1){
    // y = mx + n
    m1=randomInt(-4,4)||1; n1=randomInt(-5,5);
    m2=randomInt(-4,4)||2; n2=randomInt(-5,5);
    textR=`y=${m1}x${n1>=0?'+':''}${n1}`;
    textS=`y=${m2}x${n2>=0?'+':''}${n2}`;
    secants = (m1!==m2);
    if(secants){
      x=(n2-n1)/(m1-m2);
      y=m1*x+n1;
    }
  } 
  else if(tipus===2){
    // Forma general ax+by+c=0
    const a1=randomInt(1,5), b1=randomInt(1,5), c1=randomInt(-5,5);
    const a2=randomInt(1,5), b2=randomInt(1,5), c2=randomInt(-5,5);
    textR=`${a1}x${b1<0?'+':''}${b1}y${c1>=0?'+':''}${c1}=0`;
    textS=`${a2}x${b2<0?'+':''}${b2}y${c2>=0?'+':''}${c2}=0`;
    const det=a1*b2-a2*b1;
    secants=(det!==0);
    if(secants){
      x=(b1*c2-b2*c1)/det;
      y=(c1*a2-c2*a1)/det;
    }
  } 
  else {
    // Una forma fraccion√†ria simple
    const a=randomInt(1,4), b=randomInt(1,4);
    textR=`x/${a}=y/${b}`;
    m1=b/a; n1=0;
    const c=randomInt(1,4), d=randomInt(1,4);
    textS=`x/${c}=y/${d}`;
    m2=d/c; n2=0;
    secants=(m1!==m2);
    if(secants){
      x=0; y=0; // passen per origen, secants a O
    }
  }

  const respostaSec=secants ? "S√≠" : "No";
  const respostaPunt = secants ? `(${x.toFixed(2)},${y.toFixed(2)})` : "No existeix";

  document.getElementById("exerciseContent").innerHTML=`
    <p>Estudia si les rectes seg√ºents s√≥n secants. Si ho s√≥n, troba'n el punt de tall:</p>
    <p><b>r:</b> ${textR}</p>
    <p><b>s:</b> ${textS}</p>
    <label>Secants?</label>
    <select id="secantsSel">
      <option value="">--Selecciona--</option>
      <option value="S√≠">S√≠</option>
      <option value="No">No</option>
    </select><br><br>
    <label>Punt de tall:</label>
    <input id="answer1" placeholder="Ex: (x,y)"><br><br>
    <button onclick="checkSecants('${respostaSec}','${respostaPunt}')">Comprovar</button>
    <button onclick="exercises['Rectes secants']()">Nova activitat</button>
  `;
  document.getElementById("feedback").innerHTML="";
},

  // 9Ô∏è‚É£ TRIANGLES

  "Triangles":()=>{
    const ax=randomInt(-3,2), ay=randomInt(0,2);
    const bx=ax+randomInt(3,6), by=ay;
    const cx=ax+randomInt(2,4), cy=ay+randomInt(3,6);

    const ab=Math.sqrt((bx-ax)**2+(by-ay)**2);
    const bc=Math.sqrt((cx-bx)**2+(cy-by)**2);
    const ca=Math.sqrt((ax-cx)**2+(ay-cy)**2);

    // angles amb la llei dels cosinus
    const A=(Math.acos((ab**2+ca**2-bc**2)/(2*ab*ca))*180/Math.PI).toFixed(1);
    const B=(Math.acos((ab**2+bc**2-ca**2)/(2*ab*bc))*180/Math.PI).toFixed(1);
    const C=(180 - A - B).toFixed(1);

    document.getElementById("exerciseContent").innerHTML=`
      <p>Donat el triangle A(${ax},${ay}), B(${bx},${by}), C(${cx},${cy}):</p>
      <p><b>a)</b> Calcula la longitud dels seus costats.</p>
      <input id="answer1" placeholder="Ex: AB=..., BC=..., CA=..."><br><br>
      <p><b>b)</b> Calcula els seus angles (en graus).</p>
      <input id="answer2" placeholder="Ex: A=..., B=..., C=..."><br><br>
      <button onclick="checkTriangleAnswers(${ab.toFixed(2)},${bc.toFixed(2)},${ca.toFixed(2)},${A},${B},${C})">Comprovar</button>
      <button onclick="exercises['Triangles']()">Nova activitat</button>
    `;
    document.getElementById("feedback").innerHTML="";
  },

    // üîπ PARAL¬∑LELOGRAM
  "Paral¬∑lelogram":()=>{
  const ax=randomInt(-4,4), ay=randomInt(-4,4);
  const bx=ax+randomInt(2,5), by=ay;
  const cx=bx+randomInt(-1,2), cy=by+randomInt(2,5);
  const dx=ax+(cx-bx), dy=ay+(cy-by);

  const ab=Math.sqrt((bx-ax)**2+(by-ay)**2).toFixed(2);
  const bc=Math.sqrt((cx-bx)**2+(cy-by)**2).toFixed(2);
  const area=(ab*bc).toFixed(2);

  document.getElementById("exerciseContent").innerHTML=`
    <p>Les coordenades dels v√®rtexs d‚Äôun paral¬∑lelogram s√≥n:</p>
    <p>A(${ax},${ay}), B(${bx},${by}), C(${cx},${cy}) i D(${dx},${dy})</p>

    <p><b>a)</b> Calcula la longitud dels costats AB i BC.</p>
    <input id="answer1" placeholder="Ex: AB=..., BC=..."><br><br>

    <p><b>b)</b> Calcula l‚Äô√†rea del paral¬∑lelogram.</p>
    <input id="answer2" placeholder="Ex: √Ärea=..."><br><br>

    <button id="checkBtn">Comprovar</button>
    <button id="newBtn">Nova activitat</button>
  `;
  document.getElementById("feedback").innerHTML="";

  // Funcions de botons
  document.getElementById("checkBtn").onclick = function(){
    checkParallelogramAnswers(ab, bc, area);
  };
  document.getElementById("newBtn").onclick = function(){
    exercises["Paral¬∑lelogram"]();
  };
},


  // üîü DIST√ÄNCIES I PUNTS A RECTES
  "Dist√†ncies i punts a rectes":()=>{
    const a=randomInt(1,5), b=randomInt(1,5), c=randomInt(-10,10);
    const px=randomInt(-5,5), py=randomInt(-5,5);
    const d=(Math.abs(a*px+b*py+c)/Math.sqrt(a*a+b*b)).toFixed(2);
    const ans=`d=${d}`;
    document.getElementById("exerciseContent").innerHTML=`
      <p>Calcula la dist√†ncia del punt P(${px},${py}) a la recta ${a}x+${b}y+${c}=0</p>
      <input id="answer1" placeholder="Ex: d=...">
      <button onclick="checkTextAnswers(['${ans}'])">Comprovar</button>
      <button onclick="exercises['Dist√†ncies i punts a rectes']()">Nova activitat</button>`;
    document.getElementById("feedback").innerHTML="";
  }

};

// FUNCIONS GENERALS
function openPopup(title){
  document.getElementById("exerciseTitle").textContent=title;
  document.getElementById("exercisePopup").style.display="flex";
  exercises[title]();
}

function checkTriangleAnswers(ab, bc, ca, A, B, C){
  const user1=document.getElementById("answer1").value.trim().toLowerCase().replace(/\s+/g,'');
  const user2=document.getElementById("answer2").value.trim().toLowerCase().replace(/\s+/g,'');
  const expected1=`ab=${ab.toFixed(2)},bc=${bc.toFixed(2)},ca=${ca.toFixed(2)}`.toLowerCase().replace(/\s+/g,'');
  const expected2=`a=${A},b=${B},c=${C}`.toLowerCase().replace(/\s+/g,'');

  const fb=document.getElementById("feedback");
  if(user1===expected1 && user2===expected2){
    fb.innerHTML="‚úÖ Correcte!";
    onExerciseCorrect();
  } else {
    fb.innerHTML=`‚ùå Incorrecte.<br>Respostes esperades:<br>Costats: ${expected1}<br>Angles: ${expected2}`;
  }
}

function checkParallelogramAnswers(ab, bc, area){
  const user1=document.getElementById("answer1").value.trim().toLowerCase().replace(/\s+/g,'');
  const user2=document.getElementById("answer2").value.trim().toLowerCase().replace(/\s+/g,'');
  
  const exp1=`ab=${ab},bc=${bc}`.toLowerCase().replace(/\s+/g,'');
  const exp2=`√†rea=${area}`.toLowerCase().replace(/\s+/g,'');

  const fb=document.getElementById("feedback");

  if(user1===exp1 && user2===exp2){
    fb.innerHTML="‚úÖ Correcte! Els costats i l‚Äô√†rea s√≥n correctes.";
    onExerciseCorrect();
  } else if(user1===exp1){
    fb.innerHTML="‚úÖ Costats correctes, per√≤ ‚ùå √†rea incorrecta.";
  } else if(user2===exp2){
    fb.innerHTML="‚úÖ √Ärea correcta, per√≤ ‚ùå costats incorrectes.";
  } else {
    fb.innerHTML=`‚ùå Incorrecte.<br>Respostes esperades:<br>AB=${ab}, BC=${bc}<br>√Ärea=${area}`;
  }
}

function checkSecants(correctSec, correctPoint){
  const userSel=document.getElementById("secantsSel").value;
  const userPoint=document.getElementById("answer1").value.trim().toLowerCase().replace(/\s+/g,'');
  const fb=document.getElementById("feedback");

  const expPoint=correctPoint.toLowerCase().replace(/\s+/g,'');
  const isPointCorrect = userPoint===expPoint;

  if(userSel===correctSec && isPointCorrect){
    fb.innerHTML="‚úÖ Correcte! Les dues respostes s√≥n encertades.";
    onExerciseCorrect();
  } else if(userSel===correctSec){
    fb.innerHTML=`‚úÖ Correcte que s√≥n "${correctSec}", per√≤ ‚ùå punt de tall incorrecte (esperat: ${correctPoint}).`;
  } else {
    fb.innerHTML=`‚ùå Incorrecte.<br>Respostes esperades: Secants? ${correctSec} | Punt: ${correctPoint}`;
  }
}

// ================== EXPERI√àNCIA =====================
let correctExercises=0;
let xp=parseInt(localStorage.getItem("xp"))||0;
let level=parseInt(localStorage.getItem("level"))||1;
let xpGainBase=50;

function addXP(amount){
  xp+=amount;
  const xpMax=level*100;
  if(xp>=xpMax){ xp-=xpMax; level++; gainTitle(level); }
  localStorage.setItem("xp",xp);
  localStorage.setItem("level",level);
  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);
}
function gainTitle(level){
  const titles={
    1:"Custodi del Flux",2:"Guardi√† del Patr√≥",3:"Savi d‚ÄôEkuatia",
    4:"Somniador de Tangentia",5:"Vigilant de Complexia",
    6:"Cercador de Functonia",7:"Mestre de Derivalia"
  };
  const newTitle=titles[level]||`Aventurer Nivell ${level}`;
  alert(`‚ú® Has pujat de nivell! Nou t√≠tol: ${newTitle}`);
  localStorage.setItem("title",newTitle);
}
function onExerciseCorrect(){
  correctExercises++;
  if(correctExercises%5===0){
    const earnedXP=Math.max(10,xpGainBase-(level-1)*5);
    addXP(earnedXP);
  }
}
</script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// üîπ Configuraci√≥ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDPVUQZXaSAARwROsDgvlohMvB-esYvMrA",
  authDomain: "mythomathic.firebaseapp.com",
  projectId: "mythomathic",
  storageBucket: "mythomathic.firebasestorage.app",
  messagingSenderId: "396574593247",
  appId: "1:396574593247:web:5b7f02c53de5613eda996a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

// üîπ Quan l‚Äôusuari est√† autenticat, recuperem el seu XP actual
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    const ref = doc(db, "users", user.uid);
    const snapshot = await getDoc(ref);
    if (snapshot.exists()) {
      const data = snapshot.data();
      xp = data.xp || 0;
      level = data.level || 1;
      localStorage.setItem("xp", xp);
      localStorage.setItem("level", level);
    }
  } else {
    console.warn("Usuari no autenticat ‚Äî XP nom√©s local.");
  }
});

// üîπ Funci√≥ per sincronitzar XP amb la base de dades
async function updateXPInDB(newXP, newLevel) {
  if (!currentUser) return;
  try {
    await updateDoc(doc(db, "users", currentUser.uid), {
      xp: newXP,
      level: newLevel
    });
    console.log("‚úÖ XP actualitzat al n√∫vol:", newXP, "nivell:", newLevel);
  } catch (err) {
    console.error("‚ùå Error actualitzant XP a Firestore:", err);
  }
}

// ‚ú® Modifica la funci√≥ addXP perqu√® actualitzi Firebase tamb√©
window.addXP = async function(amount) {
  xp += amount;
  const xpMax = level * 100;
  if (xp >= xpMax) {
    xp -= xpMax;
    level++;
    gainTitle(level);
  }

  localStorage.setItem("xp", xp);
  localStorage.setItem("level", level);

  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);

  await updateXPInDB(xp, level);
};


</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
 src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

</body>
</html>

