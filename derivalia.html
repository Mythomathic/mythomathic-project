<!DOCTYPE html> 
<html lang="ca"> 
    <head> 
        <meta charset="UTF-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <title>Derivalia - Mythomathic</title> 
        <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"> 
        <link rel="stylesheet" href="derivalia.css"> 
    </head> 
<body> 
    <header> 
<button class="back-button" onclick="goTo('map.html')">‚¨Ö Mapa</button> 
<div class="title-center"> 
<img src="D_Title.png" alt="Derivalia" class="title-img"> 
</div> 
<div class="header-buttons"> 
    <button onclick="openLore()">üìú Lore</button> 
    <button onclick="toggleMenu()">‚ò∞ Men√∫</button> 
</div> 
<nav id="menu"> 
    <ul> <li onclick="goTo('map.html')">Mapa</li> 
        <li onclick="goTo('perfil.html')">Perfil</li> 
        <li onclick="goTo('config.html')">Configuraci√≥</li> 
        <li onclick="goTo('sobremi.html')">Sobre mi</li> 
        <li onclick="goTo('contacte.html')">Contacte</li> 
    </ul> 
</nav> 
</header> 

<main class="dimension-container">
  <aside class="categories">
    <button onclick="showSymbols('basics')">Derivades b√†siques</button>
    <button onclick="showSymbols('exp')">Exponencials i logar√≠tmiques</button>
    <button onclick="showSymbols('trig')">Trigonom√®triques</button>
    <button onclick="showSymbols('cadena')">Regla de la cadena</button>
  </aside>

  <div class="symbols">
    <img src="icon-der.png" class="symbol" data-cat="basics" style="top:200px; left:400px;" onclick="openPopup('Derivades b√†siques')">
    <img src="icon-der.png" class="symbol" data-cat="exp" style="top:300px; left:700px;" onclick="openPopup('Derivades exponencials i logar√≠tmiques')">
    <img src="icon-der.png" class="symbol" data-cat="trig" style="top:420px; left:600px;" onclick="openPopup('Derivades trigonom√®triques')">
    <img src="icon-der.png" class="symbol" data-cat="cadena" style="top:600px; left:800px;" onclick="openPopup('Regla de la cadena')">
  </div>
</main>

<!-- POPUP LORE --> 
<div id="lorePopup" class="popup"> 
  <div class="popup-content lore-content"> 
    <span class="close" onclick="closeLore()">&times;</span>
    <img src="lore_R.png" alt="Pergam√≠" class="scroll-img"> 
  </div> 
</div>

<div id="exercisePopup" class="popup">
  <div class="popup-content">
    <span class="close" onclick="closePopup()">&times;</span>
    <h2 id="exerciseTitle"></h2>
    <div id="exerciseContent"></div>
    <p id="feedback"></p>
  </div>
</div>

<!-- CHATBOT -->
<div id="capy-toggle">
  <img src="capy.png" alt="Capy">
</div>

<div id="capy-chat" class="hidden">
  <div class="capy-header">
    <img src="capy.png" alt="Capy">
    <span>Capy - Guia</span>
  </div>
  <div id="capy-messages"></div>
  <input id="capy-input" placeholder="Pregunta a Capy...">
  <div id="capy-thinking" class="hidden">
  <span class="dot"></span>
  <span class="dot"></span>
  <span class="dot"></span>
</div>
</div>


<script>
// function toggleMenu(){}
//function goTo(p){window.location.href=p;}

function toggleMenu() { 
  document.getElementById('menu').classList.toggle('active'); 
} 

function goTo(page) { 
  window.location.href = page; 
} 

function openLore() { 
  document.getElementById("lorePopup").style.display = "flex"; 
} 

// funci√≥ existent: tanca el popup lore
  function closeLore(){
    const lp = document.getElementById("lorePopup");
    if(lp) lp.style.display = "none";
  }

  // fallback: assegurem l'event si l'atribut onclick no s'executa per algun motiu
  document.addEventListener("DOMContentLoaded", () => {
    const closeBtn = document.querySelector(".lore-content .close");
    if(closeBtn){
      closeBtn.addEventListener("click", closeLore);
    }
    // Tamb√© fem que fer click a la capa fosca tanqui el popup (opcional)
    const lorePopup = document.getElementById("lorePopup");
    if(lorePopup){
      lorePopup.addEventListener("click", (e) => {
        if(e.target === lorePopup) closeLore(); // nom√©s si cliques fora del contingut
      });
    }
  });


/* ---------- CHATBOT ---------- */
const capyToggle = document.getElementById("capy-toggle");
const capyChat = document.getElementById("capy-chat");
const capyInput = document.getElementById("capy-input");
const capyMessages = document.getElementById("capy-messages");

capyToggle.onclick = () => capyChat.classList.toggle("hidden");

capyInput.addEventListener("keypress", async (e) => {
  if (e.key === "Enter" && capyInput.value.trim()) {
    const msg = capyInput.value.trim();
    capyMessages.innerHTML += `<p><b>Tu:</b> ${msg}</p>`;
    capyInput.value = "";

    // MOSTREM punts de pensament
    const thinking = document.getElementById("capy-thinking");
    thinking.classList.remove("hidden");

    // Enviem el missatge al servidor
    try {
      const res = await fetch('https://mythomathic-server.onrender.com/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg }),
      });

      const data = await res.json();

      // OCULTEM punts quan arriba la resposta
      thinking.classList.add("hidden");

      // Afegim missatge de Capy amb s√≠mbols matem√†tics
      capyMessages.innerHTML += `<p><b>Capy:</b> ${data.reply}</p>`;
      MathJax.typesetPromise();
      capyMessages.scrollTop = capyMessages.scrollHeight;

    } catch (err) {
      thinking.classList.add("hidden"); // assegurem amagar punts si hi ha error
      capyMessages.innerHTML += `<p><b>Capy:</b> Ups! Hi ha hagut un error al enviar el missatge.</p>`;
      capyMessages.scrollTop = capyMessages.scrollHeight;
    }
  }
});


function showSymbols(cat){
  document.querySelectorAll('.symbol').forEach(s=>s.style.display='none');
  document.querySelectorAll(`.symbol[data-cat="${cat}"]`).forEach(s=>s.style.display='block');
}
document.addEventListener('DOMContentLoaded',()=>showSymbols('basics'));
function closePopup(){document.getElementById('exercisePopup').style.display='none';}
function randomChoice(a){return a[Math.floor(Math.random()*a.length)];}

// ===== EXERCICIS =====
const exercises = {

  "Derivades b√†siques":()=> {
    const exemples=[
      {text:"f(x)=x¬≥+2x¬≤‚àí5x+1", ans:"f'(x)=3x¬≤+4x‚àí5"},
      {text:"f(x)=4x‚Åµ‚àí3x¬≤+7", ans:"f'(x)=20x‚Å¥‚àí6x"},
      {text:"f(x)=‚àöx+2x", ans:"f'(x)=1/(2‚àöx)+2"},
      {text:"f(x)=1/x¬≤+5x", ans:"f'(x)=‚àí2/x¬≥+5"}
    ];
    renderExercise(randomChoice(exemples),"Derivades b√†siques");
  },

  "Derivades exponencials i logar√≠tmiques":()=> {
    const exemples=[
      {text:"f(x)=eÀ£", ans:"f'(x)=eÀ£"},
      {text:"f(x)=3eÀ£+2", ans:"f'(x)=3eÀ£"},
      {text:"f(x)=e^(2x)", ans:"f'(x)=2e^(2x)"},
      {text:"f(x)=lnx", ans:"f'(x)=1/x"},
      {text:"f(x)=2ln(5x)", ans:"f'(x)=2/x"},
      {text:"f(x)=ln(3x¬≤+1)", ans:"f'(x)=(6x)/(3x¬≤+1)"}
    ];
    renderExercise(randomChoice(exemples),"Derivades exponencials i logar√≠tmiques");
  },

  "Derivades trigonom√®triques":()=> {
    const exemples=[
      {text:"f(x)=‚àí5sinx", ans:"f'(x)=‚àí5cosx"},
      {text:"f(x)=sinx+6", ans:"f'(x)=cosx"},
      {text:"f(x)=cosx/10", ans:"f'(x)=‚àísinx/10"},
      {text:"f(x)=6tanx", ans:"f'(x)=6sec¬≤x"},
      {text:"f(x)=arcsinx", ans:"f'(x)=1/‚àö(1‚àíx¬≤)"},
      {text:"f(x)=4arccosx", ans:"f'(x)=‚àí4/‚àö(1‚àíx¬≤)"},
      {text:"f(x)=arctanx/2", ans:"f'(x)=1/(2(1+x¬≤))"},
      {text:"f(x)=sin(x¬≤)‚àíx", ans:"f'(x)=2xcos(x¬≤)‚àí1"},
      {text:"f(x)=cos3x", ans:"f'(x)=‚àí3sin3x"},
      {text:"f(x)=arctan(3x¬≤+8x)", ans:"f'(x)=(6x+8)/(1+(3x¬≤+8x)¬≤)"}
    ];
    renderExercise(randomChoice(exemples),"Derivades trigonom√®triques");
  },

  "Regla de la cadena":()=> {
    const exemples=[
      {text:"f(x)=sin(3x)", ans:"f'(x)=3cos(3x)"},
      {text:"f(x)=cos(2x¬≤)", ans:"f'(x)=‚àí4xsin(2x¬≤)"},
      {text:"f(x)=e^(x¬≤+1)", ans:"f'(x)=2xe^(x¬≤+1)"},
      {text:"f(x)=ln(5x¬≤+3)", ans:"f'(x)=(10x)/(5x¬≤+3)"},
      {text:"f(x)=tan(4x)", ans:"f'(x)=4sec¬≤(4x)"}
    ];
    renderExercise(randomChoice(exemples),"Regla de la cadena");
  }
};

// ===== FUNCIONS AUXILIARS =====
function renderExercise(ex,section){
  document.getElementById("exerciseContent").innerHTML=`
    <p>Calcula la derivada de:</p>
    <b>${ex.text}</b><br><br>
    <input id="answer1" placeholder="Ex: f'(x)=...">
    <button id="checkBtn">Comprovar</button>
    <button id="newBtn">Nova activitat</button>
  `;
  document.getElementById("feedback").innerHTML="";

  document.getElementById("checkBtn").onclick = function(){
    checkTextAnswers([ex.ans]);
  }
  document.getElementById("newBtn").onclick = function(){
    exercises[section]();
  }
}

function openPopup(title){
  document.getElementById("exerciseTitle").textContent=title;
  document.getElementById("exercisePopup").style.display="flex";
  exercises[title]();
}

function checkTextAnswers(expected){
  const user=document.getElementById("answer1").value.trim().toLowerCase().replace(/\s+/g,'');
  const valid=expected.map(e=>e.toLowerCase().replace(/\s+/g,''));
  const fb=document.getElementById("feedback");
  
  if(valid.includes(user)){
    fb.innerHTML="‚úÖ Correcte!";
    onExerciseCorrect();
  } else {
    fb.innerHTML=`‚ùå Incorrecte (resposta esperada: ${expected[0]})`;
  }
}


// ================== EXPERI√àNCIA =====================
let correctExercises=0;
let xp=parseInt(localStorage.getItem("xp"))||0;
let level=parseInt(localStorage.getItem("level"))||1;
let xpGainBase=50;

function addXP(amount){
  xp+=amount;
  const xpMax=level*100;
  if(xp>=xpMax){ xp-=xpMax; level++; gainTitle(level); }
  localStorage.setItem("xp",xp);
  localStorage.setItem("level",level);
  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);
}
function gainTitle(level){
  const titles={
    1:"Custodi del Flux",2:"Guardi√† del Patr√≥",3:"Savi d‚ÄôEkuatia",
    4:"Somniador de Tangentia",5:"Vigilant de Complexia",
    6:"Cercador de Functonia",7:"Mestre de Derivalia"
  };
  const newTitle=titles[level]||`Aventurer Nivell ${level}`;
  alert(`‚ú® Has pujat de nivell! Nou t√≠tol: ${newTitle}`);
  localStorage.setItem("title",newTitle);
}
function onExerciseCorrect(){
  correctExercises++;
  if(correctExercises%5===0){
    const earnedXP=Math.max(10,xpGainBase-(level-1)*5);
    addXP(earnedXP);
  }
}
</script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// üîπ Configuraci√≥ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDPVUQZXaSAARwROsDgvlohMvB-esYvMrA",
  authDomain: "mythomathic.firebaseapp.com",
  projectId: "mythomathic",
  storageBucket: "mythomathic.firebasestorage.app",
  messagingSenderId: "396574593247",
  appId: "1:396574593247:web:5b7f02c53de5613eda996a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

// üîπ Quan l‚Äôusuari est√† autenticat, recuperem el seu XP actual
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    const ref = doc(db, "users", user.uid);
    const snapshot = await getDoc(ref);
    if (snapshot.exists()) {
      const data = snapshot.data();
      xp = data.xp || 0;
      level = data.level || 1;
      localStorage.setItem("xp", xp);
      localStorage.setItem("level", level);
    }
  } else {
    console.warn("Usuari no autenticat ‚Äî XP nom√©s local.");
  }
});

// üîπ Funci√≥ per sincronitzar XP amb la base de dades
async function updateXPInDB(newXP, newLevel) {
  if (!currentUser) return;
  try {
    await updateDoc(doc(db, "users", currentUser.uid), {
      xp: newXP,
      level: newLevel
    });
    console.log("‚úÖ XP actualitzat al n√∫vol:", newXP, "nivell:", newLevel);
  } catch (err) {
    console.error("‚ùå Error actualitzant XP a Firestore:", err);
  }
}

// ‚ú® Modifica la funci√≥ addXP perqu√® actualitzi Firebase tamb√©
window.addXP = async function(amount) {
  xp += amount;
  const xpMax = level * 100;
  if (xp >= xpMax) {
    xp -= xpMax;
    level++;
    gainTitle(level);
  }

  localStorage.setItem("xp", xp);
  localStorage.setItem("level", level);

  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);

  await updateXPInDB(xp, level);
};

</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
 src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

</body>
</html>
