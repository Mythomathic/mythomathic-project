<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complexia - Mythomathic</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="complexia.css"> 
</head>
<body>
<header>
  <button class="back-button" onclick="goTo('map.html')">‚¨Ö Mapa</button>
  <div class="title-center">
    <img src="C_Title.png" alt="Complexia" class="title-img">
  </div>
  <div class="header-buttons">
    <button onclick="openLore()">üìú Lore</button>
    <button onclick="toggleMenu()">‚ò∞ Men√∫</button>
  </div>
  <nav id="menu">
    <ul>
      <li onclick="goTo('map.html')">Mapa</li>
      <li onclick="goTo('perfil.html')">Perfil</li>
      <li onclick="goTo('config.html')">Configuraci√≥</li>
      <li onclick="goTo('sobremi.html')">Sobre mi</li>
      <li onclick="goTo('contacte.html')">Contacte</li>
    </ul>
  </nav>
</header>

<main class="dimension-container">
  <aside class="categories">
    <button onclick="showSymbols('forma')">Forma bin√≤mica</button>
    <button onclick="showSymbols('equacions')">Equacions i identitats</button>
  </aside>

  <div class="symbols">
    <!-- Forma bin√≤mica -->
    <img src="icon-complex.png" alt="Complex" class="symbol" data-cat="forma" style="top:400px; left:600px;" onclick="openPopup('Forma polar')">
    <img src="icon-complex.png" alt="Complex" class="symbol" data-cat="forma" style="top:520px; left:800px;" onclick="openPopup('M√≤dul i argument')">
    <img src="icon-complex.png" alt="Complex" class="symbol" data-cat="forma" style="top:590px; left:350px;" onclick="openPopup('Operacions amb z')">
    <img src="icon-complex.png" alt="Complex" class="symbol" data-cat="forma" style="top:530px; left:460px;" onclick="openPopup('Multiplicacions')">
    <img src="icon-complex.png" alt="Complex" class="symbol" data-cat="forma" style="top:620px; left:480px;" onclick="openPopup('Divisions')">
    <img src="icon-complex.png" alt="Complex" class="symbol" data-cat="forma" style="top:520px; left:730px;" onclick="openPopup('Pot√®ncies de i')">

    <!-- Equacions i identitats -->
    <img src="icon-complex.png" alt="Complex" class="symbol" data-cat="equacions" style="top:470px; left:600px;" onclick="openPopup('Pot√®ncies i radicals especials')">
    <img src="icon-complex.png" alt="Complex" class="symbol" data-cat="equacions" style="top:520px; left:730px;" onclick="openPopup('Equacions en C')">
  </div>
</main>

<!-- POPUP LORE --> 
<div id="lorePopup" class="popup"> 
  <div class="popup-content lore-content"> 
    <span class="close" onclick="closeLore()">&times;</span>
    <img src="lore_R.png" alt="Pergam√≠" class="scroll-img"> 
  </div> 
</div> 

<!-- Popup d'exercicis -->
<div id="exercisePopup" class="popup">
  <div class="popup-content">
    <span class="close" onclick="closePopup()">&times;</span>
    <h2 id="exerciseTitle"></h2>
    <div id="exerciseContent"></div>
    <p id="feedback"></p>
  </div>
</div>

<!-- CHATBOT -->
<div id="capy-toggle">
  <img src="capy2.png" alt="Capy">
</div>

<div id="capy-chat" class="hidden">
  <div class="capy-header">
    <img src="capy2.png" alt="Capy">
    <span>Capy - Guia</span>
  </div>
  <div id="capy-messages"></div>
  <input id="capy-input" placeholder="Pregunta a Capy...">
  <div id="capy-thinking" class="hidden">
  <span class="dot"></span>
  <span class="dot"></span>
  <span class="dot"></span>
</div>
</div>

<script>
function toggleMenu(){document.getElementById('menu').classList.toggle('active');}
function goTo(page){window.location.href=page;}

function openLore() { 
  document.getElementById("lorePopup").style.display = "flex"; 
} 

function closeLore(){
  const lp = document.getElementById("lorePopup");
  if(lp) lp.style.display = "none";
}

document.addEventListener("DOMContentLoaded", () => {
  const closeBtn = document.querySelector(".lore-content .close");
  if(closeBtn){
    closeBtn.addEventListener("click", closeLore);
  }
  const lorePopup = document.getElementById("lorePopup");
  if(lorePopup){
    lorePopup.addEventListener("click", (e) => {
      if(e.target === lorePopup) closeLore();
    });
  }
});

/* ---------- CHATBOT ---------- */
const capyToggle = document.getElementById("capy-toggle");
const capyChat = document.getElementById("capy-chat");
const capyInput = document.getElementById("capy-input");
const capyMessages = document.getElementById("capy-messages");

capyToggle.onclick = () => capyChat.classList.toggle("hidden");

capyInput.addEventListener("keypress", async (e) => {
  if (e.key === "Enter" && capyInput.value.trim()) {
    const msg = capyInput.value.trim();
    capyMessages.innerHTML += `<p><b>Tu:</b> ${msg}</p>`;
    capyInput.value = "";

    // MOSTREM punts de pensament
    const thinking = document.getElementById("capy-thinking");
    thinking.classList.remove("hidden");

    // Enviem el missatge al servidor
    try {
      const res = await fetch('https://mythomathic-server.onrender.com/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg }),
      });

      const data = await res.json();

      // OCULTEM punts quan arriba la resposta
      thinking.classList.add("hidden");

      // Afegim missatge de Capy amb s√≠mbols matem√†tics
      capyMessages.innerHTML += `<p><b>Capy:</b> ${data.reply}</p>`;
      MathJax.typesetPromise();
      capyMessages.scrollTop = capyMessages.scrollHeight;

    } catch (err) {
      thinking.classList.add("hidden"); // assegurem amagar punts si hi ha error
      capyMessages.innerHTML += `<p><b>Capy:</b> Ups! Hi ha hagut un error al enviar el missatge.</p>`;
      capyMessages.scrollTop = capyMessages.scrollHeight;
    }
  }
});


function showSymbols(type){
  document.querySelectorAll(".symbol").forEach(el=>el.style.display="none");
  document.querySelectorAll(".symbol[data-cat='"+type+"']").forEach(el=>el.style.display="block");
}
document.addEventListener("DOMContentLoaded",()=>{showSymbols("forma");});
function closePopup(){document.getElementById("exercisePopup").style.display="none";}

function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function randomChoice(arr){return arr[randomInt(0,arr.length-1)];}

const exercises={
  "Forma polar":()=>{
    const a=randomInt(-6,6), b=randomInt(1,6);
    const mod=Math.sqrt(a*a+b*b).toFixed(2);
    const arg=(Math.atan2(b,a)*180/Math.PI).toFixed(2);
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`
      <p>Expressa en forma polar el nombre <b>z=${a}+${b}i</b>.</p>
      <p>Introdueix m√≤dul i argument (graus):</p>
      <input id="answer1" placeholder="M√≤dul">
      <input id="answer2" placeholder="Argument">
      <button onclick="checkDoubleAnswer(${mod},${arg})">Comprovar</button>
      <button onclick="exercises['Forma polar']()">Nova activitat</button>`;
  },

  "M√≤dul i argument":()=>{
    const a=randomInt(1,6), b=randomInt(1,6);
    const mod=Math.sqrt(a*a+b*b).toFixed(2);
    const arg=(Math.atan2(b,a)*180/Math.PI).toFixed(2);
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`
      <p>Donat <b>z=${a}+${b}i</b>, calcula |z| i Arg(z).</p>
      <input id="answer1" placeholder="M√≤dul">
      <input id="answer2" placeholder="Argument">
      <button onclick="checkDoubleAnswer(${mod},${arg})">Comprovar</button>
      <button onclick="exercises['M√≤dul i argument']()">Nova activitat</button>`;
  },

  "Operacions amb z":()=>{
    const a=randomInt(-4,4), b=randomInt(-4,4), c=randomInt(-4,4), d=randomInt(-4,4);
    const sum=[a+c,b+d], diff=[a-c,b-d];
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`
      <p>Donats <b>z1=${a}${b>=0?'+':''}${b}i</b> i <b>z2=${c}${d>=0?'+':''}${d}i</b>, calcula:</p>
      <p>1) z1+z2</p>
      <p>2) z1‚àíz2</p>
      <input id="answer1" placeholder="Suma">
      <input id="answer2" placeholder="Resta">
      <button onclick="checkTextAnswers(['${sum[0]}${sum[1]>=0?'+':''}${sum[1]}i','${diff[0]}${diff[1]>=0?'+':''}${diff[1]}i'])">Comprovar</button>
      <button onclick="exercises['Operacions amb z']()">Nova activitat</button>`;
  },

  "Multiplicacions":()=>{
    const a=randomInt(-3,3), b=randomInt(-3,3), c=randomInt(-3,3), d=randomInt(-3,3);
    const real=a*c-b*d, imag=a*d+b*c;
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`
      <p>Calcula <b>(${a}${b>=0?'+':''}${b}i)¬∑(${c}${d>=0?'+':''}${d}i)</b>.</p>
      <input id="answer1" placeholder="Resultat (forma a+bi)">
      <button onclick="checkTextAnswers(['${real}${imag>=0?'+':''}${imag}i'])">Comprovar</button>
      <button onclick="exercises['Multiplicacions']()">Nova activitat</button>`;
  },

  "Divisions":()=>{
    const a=randomInt(-3,3), b=randomInt(1,4), c=randomInt(-3,3), d=randomInt(1,4);
    const denom=c*c+d*d;
    const real=((a*c+b*d)/denom).toFixed(2), imag=((b*c-a*d)/denom).toFixed(2);
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`
      <p>Calcula <b>(${a}${b>=0?'+':''}${b}i)/(${c}${d>=0?'+':''}${d}i)</b>.</p>
      <input id="answer1" placeholder="Resultat (a+bi)">
      <button onclick="checkTextAnswers(['${real}${imag>=0?'+':''}${imag}i'])">Comprovar</button>
      <button onclick="exercises['Divisions']()">Nova activitat</button>`;
  },

  "Pot√®ncies de i":()=>{
    const n=randomInt(1,12);
    const val=["1","i","-1","-i"][n%4];
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`
      <p>Calcula <b>i^${n}</b>.</p>
      <input id="answer1" placeholder="Resultat">
      <button onclick="checkTextAnswers(['${val}'])">Comprovar</button>
      <button onclick="exercises['Pot√®ncies de i']()">Nova activitat</button>`;
  },

  "Pot√®ncies i radicals especials":()=>{
    const n=randomChoice([2,3,4]);
    const theta=randomInt(0,360);
    const rootTheta=(theta/n).toFixed(2);
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`
      <p>Calcula una de les <b>${n}-enes arrels</b> de <b>z=cos(${theta}¬∞)+i¬∑sin(${theta}¬∞)</b>.</p>
      <p>Introdueix l‚Äôargument d‚Äôuna arrel en graus:</p>
      <input id="answer1" placeholder="Argument">
      <button onclick="checkAnswer(${rootTheta})">Comprovar</button>
      <button onclick="exercises['Pot√®ncies i radicals especials']()">Nova activitat</button>`;
  },

  "Equacions en C":()=>{
    const a=randomInt(1,5), b=randomInt(1,5);
    const container=document.getElementById("exerciseContent");
    container.innerHTML=`
      <p>Resol l‚Äôequaci√≥ <b>z¬≤+${a}z+${b}=0</b> en ‚ÑÇ.</p>
      <p>Introdueix les dues solucions separades per comes:</p>
      <input id="answer1" placeholder="Ex: -2, -3">
      <button onclick="checkQuadratic(${a},${b})">Comprovar</button>
      <button onclick="exercises['Equacions en C']()">Nova activitat</button>`;
  }
};

function openPopup(title){
  document.getElementById("exerciseTitle").textContent=title;
  document.getElementById("exercisePopup").style.display="flex";
  if(exercises[title]) exercises[title]();
  else document.getElementById("exerciseContent").innerHTML="<p>No disponible.</p>";
  document.getElementById("feedback").textContent="";
}

function checkAnswer(correct){
  const user=parseFloat(document.getElementById("answer1").value);
  const fb=document.getElementById("feedback");
  if(Math.abs(user-correct)<0.1){
    fb.innerHTML="‚úÖ Correcte!";
    onExerciseCorrect();
  } else fb.innerHTML=`‚ùå Incorrecte (esperat ${correct})`;
}

function checkDoubleAnswer(correct1,correct2){
  const u1=parseFloat(document.getElementById("answer1").value);
  const u2=parseFloat(document.getElementById("answer2").value);
  const fb=document.getElementById("feedback");
  if(Math.abs(u1-correct1)<0.1 && Math.abs(u2-correct2)<0.1){
    fb.innerHTML="‚úÖ Correcte!";
    onExerciseCorrect();
  } else fb.innerHTML=`‚ùå Incorrecte (esperat ${correct1}, ${correct2})`;
}

function checkTextAnswers(expected){
  const fb=document.getElementById("feedback");
  const ans=[];
  document.querySelectorAll("#exerciseContent input").forEach(el=>ans.push(el.value.replace(/\s+/g,'')));
  let ok=true;
  for(let i=0;i<expected.length;i++){
    if(ans[i]!==expected[i]) ok=false;
  }
  if(ok){
    fb.innerHTML="‚úÖ Correcte!";
    onExerciseCorrect();
  } else fb.innerHTML=`‚ùå Incorrecte (esperat ${expected.join(', ')})`;
}

function checkQuadratic(a,b){
  const disc = a*a-4*b;
  const fb = document.getElementById("feedback");
  const user=document.getElementById("answer1").value.split(",");
  if(disc >= 0){
    const r1 = (-a + Math.sqrt(disc))/2;
    const r2 = (-a - Math.sqrt(disc))/2;
    const u1 = parseFloat(user[0]), u2 = parseFloat(user[1]);
    if((Math.abs(u1-r1)<0.1 && Math.abs(u2-r2)<0.1)||(Math.abs(u1-r2)<0.1 && Math.abs(u2-r1)<0.1)){
      fb.innerHTML="‚úÖ Correcte!";
      onExerciseCorrect();
    } else fb.innerHTML=`‚ùå Incorrecte (esperat ${r1}, ${r2})`;
  } else {
    const real = (-a/2).toFixed(2);
    const imag = (Math.sqrt(-disc)/2).toFixed(2);
    const r1 = `${real}+${imag}i`;
    const r2 = `${real}-${imag}i`;
    if(user[0].replace(/\s+/g,'')===r1 && user[1].replace(/\s+/g,'')===r2 || user[0].replace(/\s+/g,'')===r2 && user[1].replace(/\s+/g,'')===r1){
      fb.innerHTML="‚úÖ Correcte!";
      onExerciseCorrect();
    } else fb.innerHTML=`‚ùå Incorrecte (esperat ${r1}, ${r2})`;
  }
}

// ================== EXPERI√àNCIA =====================
let correctExercises=0;
let xp=parseInt(localStorage.getItem("xp"))||0;
let level=parseInt(localStorage.getItem("level"))||1;
let xpGainBase=50;

function addXP(amount){
  xp+=amount;
  const xpMax=level*100;
  if(xp>=xpMax){ xp-=xpMax; level++; gainTitle(level); }
  localStorage.setItem("xp",xp);
  localStorage.setItem("level",level);
  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);
}
function gainTitle(level){
  const titles={
    1:"Custodi del Flux",2:"Guardi√† del Patr√≥",3:"Savi d‚ÄôEkuatia",
    4:"Somniador de Tangentia",5:"Vigilant de Complexia",
    6:"Cercador de Functonia",7:"Mestre de Derivalia"
  };
  const newTitle=titles[level]||`Aventurer Nivell ${level}`;
  alert(`‚ú® Has pujat de nivell! Nou t√≠tol: ${newTitle}`);
  localStorage.setItem("title",newTitle);
}
function onExerciseCorrect(){
  correctExercises++;
  if(correctExercises%5===0){
    const earnedXP=Math.max(10,xpGainBase-(level-1)*5);
    addXP(earnedXP);
  }
}
</script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// üîπ Configuraci√≥ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDPVUQZXaSAARwROsDgvlohMvB-esYvMrA",
  authDomain: "mythomathic.firebaseapp.com",
  projectId: "mythomathic",
  storageBucket: "mythomathic.firebasestorage.app",
  messagingSenderId: "396574593247",
  appId: "1:396574593247:web:5b7f02c53de5613eda996a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

// üîπ Quan l‚Äôusuari est√† autenticat, recuperem el seu XP actual
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    const ref = doc(db, "users", user.uid);
    const snapshot = await getDoc(ref);
    if (snapshot.exists()) {
      const data = snapshot.data();
      xp = data.xp || 0;
      level = data.level || 1;
      localStorage.setItem("xp", xp);
      localStorage.setItem("level", level);
    }
  } else {
    console.warn("Usuari no autenticat ‚Äî XP nom√©s local.");
  }
});

// üîπ Funci√≥ per sincronitzar XP amb la base de dades
async function updateXPInDB(newXP, newLevel) {
  if (!currentUser) return;
  try {
    await updateDoc(doc(db, "users", currentUser.uid), {
      xp: newXP,
      level: newLevel
    });
    console.log("‚úÖ XP actualitzat al n√∫vol:", newXP, "nivell:", newLevel);
  } catch (err) {
    console.error("‚ùå Error actualitzant XP a Firestore:", err);
  }
}

// ‚ú® Modifica la funci√≥ addXP perqu√® actualitzi Firebase tamb√©
window.addXP = async function(amount) {
  xp += amount;
  const xpMax = level * 100;
  if (xp >= xpMax) {
    xp -= xpMax;
    level++;
    gainTitle(level);
  }

  localStorage.setItem("xp", xp);
  localStorage.setItem("level", level);

  alert(`üèÖ Has guanyat ${amount} XP! (Nivell actual: ${level})`);

  await updateXPInDB(xp, level);
};

</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
 src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

</body>
</html>

